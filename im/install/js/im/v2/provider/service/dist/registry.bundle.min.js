this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Provider=this.BX.Messenger.v2.Provider||{};(function(e,s,a,t,r,i,l,o,d,c,n,b,h,v,p,g,u){"use strict";var P=babelHelpers.classPrivateFieldLooseKey("restResult");var F=babelHelpers.classPrivateFieldLooseKey("withBirthdays");var L=babelHelpers.classPrivateFieldLooseKey("users");var H=babelHelpers.classPrivateFieldLooseKey("chats");var f=babelHelpers.classPrivateFieldLooseKey("messages");var B=babelHelpers.classPrivateFieldLooseKey("files");var m=babelHelpers.classPrivateFieldLooseKey("recentItems");var y=babelHelpers.classPrivateFieldLooseKey("extractUser");var I=babelHelpers.classPrivateFieldLooseKey("extractChat");var M=babelHelpers.classPrivateFieldLooseKey("extractMessage");var C=babelHelpers.classPrivateFieldLooseKey("extractRecentItem");var w=babelHelpers.classPrivateFieldLooseKey("extractBirthdayItems");var S=babelHelpers.classPrivateFieldLooseKey("prepareGroupChat");var O=babelHelpers.classPrivateFieldLooseKey("prepareChatForUser");var U=babelHelpers.classPrivateFieldLooseKey("prepareChatForAdditionalUser");var j=babelHelpers.classPrivateFieldLooseKey("getBirthdayPlaceholder");class R{constructor(e){Object.defineProperty(this,j,{value:N});Object.defineProperty(this,U,{value:k});Object.defineProperty(this,O,{value:_});Object.defineProperty(this,S,{value:x});Object.defineProperty(this,w,{value:A});Object.defineProperty(this,C,{value:T});Object.defineProperty(this,M,{value:D});Object.defineProperty(this,I,{value:K});Object.defineProperty(this,y,{value:E});Object.defineProperty(this,P,{writable:true,value:void 0});Object.defineProperty(this,F,{writable:true,value:void 0});Object.defineProperty(this,L,{writable:true,value:{}});Object.defineProperty(this,H,{writable:true,value:{}});Object.defineProperty(this,f,{writable:true,value:{}});Object.defineProperty(this,B,{writable:true,value:{}});Object.defineProperty(this,m,{writable:true,value:{}});const{rawData:s,withBirthdays:a=true}=e;babelHelpers.classPrivateFieldLooseBase(this,F)[F]=a;babelHelpers.classPrivateFieldLooseBase(this,P)[P]=s}getItems(){const{items:e=[]}=babelHelpers.classPrivateFieldLooseBase(this,P)[P];e.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,y)[y](e);babelHelpers.classPrivateFieldLooseBase(this,I)[I](e);babelHelpers.classPrivateFieldLooseBase(this,M)[M](e);babelHelpers.classPrivateFieldLooseBase(this,C)[C](e)}));babelHelpers.classPrivateFieldLooseBase(this,w)[w]();return{users:Object.values(babelHelpers.classPrivateFieldLooseBase(this,L)[L]),chats:Object.values(babelHelpers.classPrivateFieldLooseBase(this,H)[H]),messages:Object.values(babelHelpers.classPrivateFieldLooseBase(this,f)[f]),files:Object.values(babelHelpers.classPrivateFieldLooseBase(this,B)[B]),recentItems:Object.values(babelHelpers.classPrivateFieldLooseBase(this,m)[m])}}}function E(e){var s;if((s=e.user)!=null&&s.id&&!babelHelpers.classPrivateFieldLooseBase(this,L)[L][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,L)[L][e.user.id]=e.user}}function K(e){if(e.chat){babelHelpers.classPrivateFieldLooseBase(this,H)[H][e.id]=babelHelpers.classPrivateFieldLooseBase(this,S)[S](e);if(e.user.id&&!babelHelpers.classPrivateFieldLooseBase(this,H)[H][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,H)[H][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,U)[U](e.user)}}else if(e.user.id){const s=g.Core.getStore().getters["recent/get"](e.user.id);if(!s||!e.options.default_user_record){babelHelpers.classPrivateFieldLooseBase(this,H)[H][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,O)[O](e)}}}function D(e){const s=e.message;if(!s){return}if(s.id===0){s.id=`${u.FakeMessagePrefix}-${e.id}`}let a=false;if(s.status===u.MessageStatus.delivered){a=true}if(o.Type.isPlainObject(s.file)){const e=s.file;s.files=[e.id];const a=g.Core.getStore().getters["files/get"](e.id);if(!a){babelHelpers.classPrivateFieldLooseBase(this,B)[B][e.id]=e}}const t=g.Core.getStore().getters["messages/getById"](s.id);if(o.Type.isArrayFilled(t==null?void 0:t.attach)){delete s.attach}babelHelpers.classPrivateFieldLooseBase(this,f)[f][s.id]={...s,viewedByOthers:a}}function T(e){var s,a;const t=(s=(a=e.message)==null?void 0:a.id)!=null?s:0;babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.id]={...e,messageId:t}}function A(){if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F]){return}const{birthdayList:e=[]}=babelHelpers.classPrivateFieldLooseBase(this,P)[P];e.forEach((e=>{if(!babelHelpers.classPrivateFieldLooseBase(this,L)[L][e.id]){babelHelpers.classPrivateFieldLooseBase(this,L)[L][e.id]=e}if(!babelHelpers.classPrivateFieldLooseBase(this,H)[H][e.id]){babelHelpers.classPrivateFieldLooseBase(this,H)[H][e.id]=babelHelpers.classPrivateFieldLooseBase(this,U)[U](e)}if(!babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.id]){const s=`${u.FakeMessagePrefix}-${e.id}`;babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.id]={...babelHelpers.classPrivateFieldLooseBase(this,j)[j](e),messageId:s};babelHelpers.classPrivateFieldLooseBase(this,f)[f][s]={id:s}}}))}function x(e){return{...e.chat,counter:e.counter,dialogId:e.id}}function _(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:u.ChatType.user,counter:e.counter,role:u.UserRole.member}}function k(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:u.ChatType.user,role:u.UserRole.member}}function N(e){return{id:e.id,isBirthdayPlaceholder:true}}class V{constructor(){this.dataIsPreloaded=false;this.firstPageIsLoaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null}static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getCollection(){return g.Core.getStore().getters["recent/getRecentCollection"]}async loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){v.Logger.warn("Im.RecentList: first page was preloaded");return Promise.resolve()}this.isLoading=true;const s=await this.requestItems({firstPage:true});this.firstPageIsLoaded=true;return s}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){v.Logger.warn("Im.RecentList: setting preloaded data",e);const{items:s,hasMore:a}=e;this.lastMessageDate=this.getLastMessageDate(s);if(!a){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;this.updateModels(e)}hideChat(e){v.Logger.warn("Im.RecentList: hide chat",e);const s=g.Core.getStore().getters["recent/get"](e);if(!s){return}g.Core.getStore().dispatch("recent/delete",{id:e});const a=g.Core.getStore().getters["application/isChatOpen"](e);if(a){r.Messenger.openChat()}g.Core.getRestClient().callMethod(u.RestMethod.imRecentHide,{DIALOG_ID:e}).catch((e=>{console.error("Im.RecentList: hide chat error",e)}))}async requestItems({firstPage:e=false}={}){const s=this.getQueryParams(e);const a=await g.Core.getRestClient().callMethod(this.getQueryMethod(),s).catch((e=>{console.error("Im.RecentList: page request error",e)}));this.pagesLoaded++;v.Logger.warn(`Im.RecentList: ${e?"First":this.pagesLoaded} page request result`,a.data());const{items:t,hasMore:r}=a.data();this.lastMessageDate=this.getLastMessageDate(t);if(!r){this.hasMoreItemsToLoad=false}this.isLoading=false;return this.updateModels(a.data())}getQueryMethod(){return u.RestMethod.imRecentList}getQueryParams(e){return{SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y",PARSE_TEXT:"Y"}}getModelSaveMethod(){return"recent/setRecent"}updateModels(e){const s=new R({rawData:e,...this.getExtractorOptions()});const a=s.getItems();const{users:t,chats:r,messages:i,files:l,recentItems:o}=a;v.Logger.warn("RecentService: prepared data for models",a);const d=g.Core.getStore().dispatch("users/set",t);const c=g.Core.getStore().dispatch("chats/set",r);const n=g.Core.getStore().dispatch("messages/store",i);const b=g.Core.getStore().dispatch("files/set",l);const h=g.Core.getStore().dispatch(this.getModelSaveMethod(),o);return Promise.all([d,c,n,b,h])}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}getExtractorOptions(){return{}}}V.instance=null;var X=babelHelpers.classPrivateFieldLooseKey("restResult");class G{constructor(e){Object.defineProperty(this,X,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,X)[X]=e}getChatId(){return babelHelpers.classPrivateFieldLooseBase(this,X)[X].chat.id}getDialogId(){return babelHelpers.classPrivateFieldLooseBase(this,X)[X].chat.dialogId}isOpenlinesChat(){return babelHelpers.classPrivateFieldLooseBase(this,X)[X].chat.type===u.ChatType.lines}getChats(){const e={...babelHelpers.classPrivateFieldLooseBase(this,X)[X].chat,hasPrevPage:babelHelpers.classPrivateFieldLooseBase(this,X)[X].hasPrevPage,hasNextPage:babelHelpers.classPrivateFieldLooseBase(this,X)[X].hasNextPage};const s={[babelHelpers.classPrivateFieldLooseBase(this,X)[X].chat.dialogId]:e};babelHelpers.classPrivateFieldLooseBase(this,X)[X].users.forEach((e=>{if(s[e.id]){s[e.id]={...s[e.id],...d.UserManager.getDialogForUser(e)}}else{s[e.id]=d.UserManager.getDialogForUser(e)}}));return Object.values(s)}getFiles(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,X)[X].files)!=null?e:[]}getUsers(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,X)[X].users)!=null?e:[]}getAdditionalUsers(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,X)[X].usersShort)!=null?e:[]}getMessages(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,X)[X].messages)!=null?e:[]}getMessagesToStore(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,X)[X].additionalMessages)!=null?e:[]}getPinnedMessageIds(){var e;const s=[];const a=(e=babelHelpers.classPrivateFieldLooseBase(this,X)[X].pins)!=null?e:[];a.forEach((e=>{s.push(e.messageId)}));return s}getReactions(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,X)[X].reactions)!=null?e:[]}}var $=babelHelpers.classPrivateFieldLooseKey("store");var W=babelHelpers.classPrivateFieldLooseKey("requestChat");var q=babelHelpers.classPrivateFieldLooseKey("markDialogAsLoading");var z=babelHelpers.classPrivateFieldLooseKey("markDialogAsLoaded");var Y=babelHelpers.classPrivateFieldLooseKey("markDialogAsNotLoaded");var Q=babelHelpers.classPrivateFieldLooseKey("isDialogLoadedMarkNeeded");var J=babelHelpers.classPrivateFieldLooseKey("updateModels");class Z{constructor(){Object.defineProperty(this,J,{value:ie});Object.defineProperty(this,Q,{value:re});Object.defineProperty(this,Y,{value:te});Object.defineProperty(this,z,{value:ae});Object.defineProperty(this,q,{value:se});Object.defineProperty(this,W,{value:ee});Object.defineProperty(this,$,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,$)[$]=g.Core.getStore()}loadChat(e){const s={dialogId:e};return babelHelpers.classPrivateFieldLooseBase(this,W)[W](u.RestMethod.imV2ChatShallowLoad,s)}loadChatWithMessages(e){const a={dialogId:e,messageLimit:s.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,W)[W](u.RestMethod.imV2ChatLoad,a)}loadChatWithContext(e,a){const t={dialogId:e,messageId:a,messageLimit:s.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,W)[W](u.RestMethod.imV2ChatLoadInContext,t)}prepareDialogId(e){if(!n.Utils.dialog.isExternalId(e)){return Promise.resolve(e)}return p.runAction(u.RestMethod.imV2ChatGetDialogId,{data:{externalId:e}}).then((e=>e.dialogId)).catch((e=>{console.error("ChatService: Load: error preparing external id",e)}))}}async function ee(e,s){const{dialogId:t}=s;babelHelpers.classPrivateFieldLooseBase(this,q)[q](t);const i=await p.runAction(e,{data:s}).catch((e=>{console.error("ChatService: Load: error loading chat",e);babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](t);throw e}));const l=await babelHelpers.classPrivateFieldLooseBase(this,J)[J](i);if(o.Type.isStringFilled(l==null?void 0:l.linesDialogId)){a.LayoutManager.getInstance().setLastOpenedElement(u.Layout.chat.name,"");return r.Messenger.openLines(l.linesDialogId)}if(babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](e)){return babelHelpers.classPrivateFieldLooseBase(this,z)[z](t)}return true}function se(e){babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("chats/update",{dialogId:e,fields:{loading:true}})}function ae(e){return babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("chats/update",{dialogId:e,fields:{inited:true,loading:false}})}function te(e){return babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("chats/update",{dialogId:e,fields:{loading:false}})}function re(e){return e!==u.RestMethod.imV2ChatShallowLoad}function ie(e){const s=new G(e);if(s.isOpenlinesChat()){return Promise.resolve({linesDialogId:s.getDialogId()})}const a=babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("chats/set",s.getChats());const t=babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("files/set",s.getFiles());const r=new d.UserManager;const i=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("users/set",s.getUsers()),r.addUsersToModel(s.getAdditionalUsers())]);const l=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("messages/setChatCollection",{messages:s.getMessages(),clearCollection:true}),babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("messages/store",s.getMessagesToStore()),babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("messages/pin/setPinned",{chatId:s.getChatId(),pinnedMessages:s.getPinnedMessageIds()}),babelHelpers.classPrivateFieldLooseBase(this,$)[$].dispatch("messages/reactions/set",s.getReactions())]);return Promise.all([a,t,i,l])}const le="CHAT";const oe="OPEN";var de=babelHelpers.classPrivateFieldLooseKey("restClient");var ce=babelHelpers.classPrivateFieldLooseKey("store");var ne=babelHelpers.classPrivateFieldLooseKey("prepareFields");var be=babelHelpers.classPrivateFieldLooseKey("addChatToModel");class he{constructor(){Object.defineProperty(this,be,{value:pe});Object.defineProperty(this,ne,{value:ve});Object.defineProperty(this,de,{writable:true,value:void 0});Object.defineProperty(this,ce,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,de)[de]=g.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,ce)[ce]=g.Core.getStore()}async createChat(e){v.Logger.warn("ChatService: createChat",e);const s=await babelHelpers.classPrivateFieldLooseBase(this,ne)[ne](e);const a=await babelHelpers.classPrivateFieldLooseBase(this,de)[de].callMethod(u.RestMethod.imV2ChatAdd,{fields:s}).catch((e=>{console.error("ChatService: createChat error:",e);throw new Error(e)}));const{chatId:t}=a.data();v.Logger.warn("ChatService: createChat result",t);const r=`chat${t}`;babelHelpers.classPrivateFieldLooseBase(this,be)[be](r,s);return r}}async function ve(e){var s,a,t,r,i,l,o,d,c,b,h,v,p,g,u,P;const F={...e};if(F.avatar){F.avatar=await n.Utils.file.getBase64(e.avatar)}F.managers=(s=F.managers)!=null?s:[];F.members=(a=F.members)!=null?a:[];const L=[...F.members,...F.managers];if(F.ownerId){L.push(F.ownerId)}F.members=[...new Set(L)];return{type:(t=(r=F.type)==null?void 0:r.toUpperCase())!=null?t:null,entityType:(i=(l=F.entityType)==null?void 0:l.toUpperCase())!=null?i:null,title:(o=F.title)!=null?o:null,avatar:(d=F.avatar)!=null?d:null,description:(c=F.description)!=null?c:null,users:F.members,managers:F.managers,ownerId:(b=F.ownerId)!=null?b:null,searchable:F.isAvailableInSearch?"Y":"N",manageUsersAdd:(h=F.manageUsersAdd)!=null?h:null,manageUsersDelete:(v=F.manageUsersDelete)!=null?v:null,manageUi:(p=F.manageUi)!=null?p:null,manageSettings:(g=F.manageSettings)!=null?g:null,canPost:(u=F.canPost)!=null?u:null,conferencePassword:(P=F.conferencePassword)!=null?P:null}}function pe(e,s){let a=s.searchable==="Y"?oe:le;if(o.Type.isStringFilled(s.entityType)){a=s.entityType.toLowerCase()}if(o.Type.isStringFilled(s.type)){a=s.type.toLowerCase()}babelHelpers.classPrivateFieldLooseBase(this,ce)[ce].dispatch("chats/set",{dialogId:e,type:a.toLowerCase(),name:s.title,userCounter:s.users.length,role:u.UserRole.owner,canPost:s.canPost})}const ge=180;class ue{async prepareAvatar(e){if(!h.isResizableImage(e)){return Promise.reject(new Error("UpdateService: prepareAvatar: incorrect image"))}const{preview:s}=await h.resizeImage(e,{width:ge,height:ge});return s}async changeAvatar(e,s){v.Logger.warn("ChatService: changeAvatar",e,s);const a=await n.Utils.file.getBase64(s);return p.runAction(u.RestMethod.imV2ChatUpdate,{data:{id:e,fields:{avatar:a}}}).catch((e=>{console.error("ChatService: changeAvatar error:",e);throw new Error(e)}))}}var Pe=babelHelpers.classPrivateFieldLooseKey("store");var Fe=babelHelpers.classPrivateFieldLooseKey("restClient");var Le=babelHelpers.classPrivateFieldLooseKey("updateChatTitleInModel");class He{constructor(){Object.defineProperty(this,Le,{value:fe});Object.defineProperty(this,Pe,{writable:true,value:void 0});Object.defineProperty(this,Fe,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe]=g.Core.getRestClient()}renameChat(e,s){v.Logger.warn("ChatService: renameChat",e,s);if(s===""){return Promise.resolve()}const a=babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe].getters["chats/get"](e);const t=a.name;babelHelpers.classPrivateFieldLooseBase(this,Le)[Le](e,s);return babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe].callMethod(u.RestMethod.imChatUpdateTitle,{dialog_id:e,title:s}).then((e=>{v.Logger.warn("ChatService: renameChat result",e.data());return Promise.resolve()})).catch((()=>{babelHelpers.classPrivateFieldLooseBase(this,Le)[Le](e,t);throw new Error("Chat rename error")}))}}function fe(e,s){babelHelpers.classPrivateFieldLooseBase(this,Pe)[Pe].dispatch("chats/update",{dialogId:e,fields:{name:s}})}var Be=babelHelpers.classPrivateFieldLooseKey("store");var me=babelHelpers.classPrivateFieldLooseKey("restClient");var ye=babelHelpers.classPrivateFieldLooseKey("sendMuteRequestDebounced");var Ie=babelHelpers.classPrivateFieldLooseKey("sendMuteRequest");class Me{constructor(){Object.defineProperty(this,Ie,{value:Ce});Object.defineProperty(this,Be,{writable:true,value:void 0});Object.defineProperty(this,me,{writable:true,value:void 0});Object.defineProperty(this,ye,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Be)[Be]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,me)[me]=g.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,ye)[ye]=o.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie],ds.DEBOUNCE_TIME)}muteChat(e){v.Logger.warn("ChatService: muteChat",e);babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].dispatch("chats/mute",{dialogId:e});const s={dialog_id:e,action:"Y"};babelHelpers.classPrivateFieldLooseBase(this,ye)[ye](s)}unmuteChat(e){v.Logger.warn("ChatService: unmuteChat",e);babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].dispatch("chats/unmute",{dialogId:e});const s={dialog_id:e,action:"N"};babelHelpers.classPrivateFieldLooseBase(this,ye)[ye](s)}}function Ce(e){const{dialog_id:s,action:a}=e;return babelHelpers.classPrivateFieldLooseBase(this,me)[me].callMethod(u.RestMethod.imChatMute,e).catch((e=>{const t=a==="Y"?"muting":"unmuting";console.error(`Im.RecentList: error ${t} chat`,e);const r=a==="Y"?"chats/unmute":"chats/mute";babelHelpers.classPrivateFieldLooseBase(this,Be)[Be].dispatch(r,{dialogId:s})}))}var we=babelHelpers.classPrivateFieldLooseKey("store");var Se=babelHelpers.classPrivateFieldLooseKey("restClient");class Oe{constructor(){Object.defineProperty(this,we,{writable:true,value:void 0});Object.defineProperty(this,Se,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,we)[we]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]=g.Core.getRestClient()}pinChat(e){v.Logger.warn("PinService: pinChat",e);babelHelpers.classPrivateFieldLooseBase(this,we)[we].dispatch("recent/pin",{id:e,action:true});const s={DIALOG_ID:e,ACTION:"Y"};babelHelpers.classPrivateFieldLooseBase(this,Se)[Se].callMethod(u.RestMethod.imRecentPin,s).catch((s=>{console.error("PinService: error pinning chat",s);babelHelpers.classPrivateFieldLooseBase(this,we)[we].dispatch("recent/pin",{id:e,action:false})}))}unpinChat(e){v.Logger.warn("PinService: unpinChat",e);babelHelpers.classPrivateFieldLooseBase(this,we)[we].dispatch("recent/pin",{id:e,action:false});const s={DIALOG_ID:e,ACTION:"N"};babelHelpers.classPrivateFieldLooseBase(this,Se)[Se].callMethod(u.RestMethod.imRecentPin,s).catch((s=>{console.error("PinService: error unpinning chat",s);babelHelpers.classPrivateFieldLooseBase(this,we)[we].dispatch("recent/pin",{id:e,action:true})}))}}const Ue=300;var je=babelHelpers.classPrivateFieldLooseKey("store");var Re=babelHelpers.classPrivateFieldLooseKey("restClient");var Ee=babelHelpers.classPrivateFieldLooseKey("messagesToRead");var Ke=babelHelpers.classPrivateFieldLooseKey("readMessagesForChat");var De=babelHelpers.classPrivateFieldLooseKey("readMessageOnClient");var Te=babelHelpers.classPrivateFieldLooseKey("decreaseChatCounter");var Ae=babelHelpers.classPrivateFieldLooseKey("readMessageOnServer");var xe=babelHelpers.classPrivateFieldLooseKey("checkChatCounter");var _e=babelHelpers.classPrivateFieldLooseKey("getDialogIdByChatId");var ke=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");class Ne{constructor(){Object.defineProperty(this,ke,{value:ze});Object.defineProperty(this,_e,{value:qe});Object.defineProperty(this,xe,{value:We});Object.defineProperty(this,Ae,{value:$e});Object.defineProperty(this,Te,{value:Ge});Object.defineProperty(this,De,{value:Xe});Object.defineProperty(this,Ke,{value:Ve});Object.defineProperty(this,je,{writable:true,value:void 0});Object.defineProperty(this,Re,{writable:true,value:void 0});Object.defineProperty(this,Ee,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,je)[je]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]=g.Core.getRestClient()}readAll(){v.Logger.warn("ReadService: readAll");babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("chats/clearCounters");babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("recent/clearUnread");return babelHelpers.classPrivateFieldLooseBase(this,Re)[Re].callMethod(u.RestMethod.imV2ChatReadAll).catch((e=>{console.error("ReadService: readAll error",e)}))}readDialog(e){v.Logger.warn("ReadService: readDialog",e);babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("recent/unread",{id:e,action:false});babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("chats/update",{dialogId:e,fields:{counter:0}});babelHelpers.classPrivateFieldLooseBase(this,Re)[Re].callMethod(u.RestMethod.imV2ChatRead,{dialogId:e}).catch((e=>{console.error("ReadService: error reading chat",e)}))}unreadDialog(e){v.Logger.warn("ReadService: unreadDialog",e);babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("recent/unread",{id:e,action:true});babelHelpers.classPrivateFieldLooseBase(this,Re)[Re].callMethod(u.RestMethod.imV2ChatUnread,{dialogId:e}).catch((s=>{console.error("ReadService: error setting chat as unread",s);babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("recent/unread",{id:e,action:false})}))}readMessage(e,s){if(!babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee][e]){babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee][e]=new Set}babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee][e].add(s);clearTimeout(this.readTimeout);this.readTimeout=setTimeout((()=>{Object.entries(babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee]).forEach((([e,s])=>{babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke](e,s)}))}),Ue)}clearDialogMark(e){v.Logger.warn("ReadService: clear dialog mark",e);const s=babelHelpers.classPrivateFieldLooseBase(this,je)[je].getters["chats/get"](e);const a=babelHelpers.classPrivateFieldLooseBase(this,je)[je].getters["recent/get"](e);if(s.markedId===0&&!(a!=null&&a.unread)){return}babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("recent/unread",{id:e,action:false});babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("chats/update",{dialogId:e,fields:{markedId:0}});babelHelpers.classPrivateFieldLooseBase(this,Re)[Re].callMethod(u.RestMethod.imV2ChatRead,{dialogId:e,onlyRecent:"Y"}).catch((e=>{console.error("ReadService: error clearing dialog mark",e)}))}}async function Ve(e,s){const a=Number.parseInt(e,10);v.Logger.warn("ReadService: readMessages",s);if(s.size===0){return}const t=[...s];delete babelHelpers.classPrivateFieldLooseBase(this,Ee)[Ee][a];const r=await babelHelpers.classPrivateFieldLooseBase(this,De)[De](a,t);v.Logger.warn("ReadService: readMessage, need to reduce counter by",r);await babelHelpers.classPrivateFieldLooseBase(this,Te)[Te](a,r);const i=await babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae](a,t).catch((e=>{console.error("ReadService: error reading message",e)}));babelHelpers.classPrivateFieldLooseBase(this,xe)[xe](i)}function Xe(e,s){const a=Math.max(...s);const t=babelHelpers.classPrivateFieldLooseBase(this,ke)[ke](e);if(a>t.lastReadId){babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,_e)[_e](e),fields:{lastId:a}})}return babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("messages/readMessages",{chatId:e,messageIds:s})}function Ge(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,ke)[ke](e);let t=a.counter-s;if(t<0){t=0}return babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,_e)[_e](e),fields:{counter:t}})}function $e(e,s){v.Logger.warn("ReadService: readMessages on server",s);return p.runAction(u.RestMethod.imV2ChatMessageRead,{data:{chatId:e,ids:s,actionUuid:t.UuidManager.getInstance().getActionUuid()}})}function We(e){const{chatId:s,counter:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,ke)[ke](s);if(t.counter>a){v.Logger.warn("ReadService: counter from server is lower than local one",t.counter,a);babelHelpers.classPrivateFieldLooseBase(this,je)[je].dispatch("chats/update",{dialogId:t.dialogId,fields:{counter:a}})}}function qe(e){const s=babelHelpers.classPrivateFieldLooseBase(this,je)[je].getters["chats/getByChatId"](e);if(!s){return 0}return s.dialogId}function ze(e){return babelHelpers.classPrivateFieldLooseBase(this,je)[je].getters["chats/getByChatId"](e)}var Ye=babelHelpers.classPrivateFieldLooseKey("store");var Qe=babelHelpers.classPrivateFieldLooseKey("restClient");class Je{constructor(){Object.defineProperty(this,Ye,{writable:true,value:void 0});Object.defineProperty(this,Qe,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe]=g.Core.getRestClient()}addToChat(e){const s={chat_id:e.chatId,users:e.members,hide_history:!e.showHistory};return babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe].callMethod(u.RestMethod.imChatUserAdd,s)}kickUserFromChat(e,s){v.Logger.warn(`UserService: kick user ${s} from chat ${e}`);const a={dialogId:e,userId:s};babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe].callMethod(u.RestMethod.imV2ChatDeleteUser,a).catch((e=>{console.error("UserService: error kicking user from chat",e)}))}leaveChat(e){this.kickUserFromChat(e,g.Core.getUserId());babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye].dispatch("chats/update",{dialogId:e,fields:{inited:false}});babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye].dispatch("recent/delete",{id:e});const s=babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye].getters["application/isChatOpen"](e);if(s){r.Messenger.openChat()}}joinChat(e){v.Logger.warn(`UserService: join chat ${e}`);babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye].dispatch("chats/update",{dialogId:e,fields:{role:u.UserRole.member}});babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe].callMethod(u.RestMethod.imV2ChatJoin,{dialogId:e}).catch((e=>{console.error("UserService: error joining chat",e)}))}}var Ze=babelHelpers.classPrivateFieldLooseKey("loadService");var es=babelHelpers.classPrivateFieldLooseKey("createService");var ss=babelHelpers.classPrivateFieldLooseKey("updateService");var as=babelHelpers.classPrivateFieldLooseKey("renameService");var ts=babelHelpers.classPrivateFieldLooseKey("muteService");var rs=babelHelpers.classPrivateFieldLooseKey("pinService");var is=babelHelpers.classPrivateFieldLooseKey("readService");var ls=babelHelpers.classPrivateFieldLooseKey("userService");var os=babelHelpers.classPrivateFieldLooseKey("initServices");class ds{constructor(){Object.defineProperty(this,os,{value:cs});Object.defineProperty(this,Ze,{writable:true,value:void 0});Object.defineProperty(this,es,{writable:true,value:void 0});Object.defineProperty(this,ss,{writable:true,value:void 0});Object.defineProperty(this,as,{writable:true,value:void 0});Object.defineProperty(this,ts,{writable:true,value:void 0});Object.defineProperty(this,rs,{writable:true,value:void 0});Object.defineProperty(this,is,{writable:true,value:void 0});Object.defineProperty(this,ls,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,os)[os]()}loadChat(e){return babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze].loadChat(e)}loadChatWithMessages(e){return babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze].loadChatWithMessages(e)}loadChatWithContext(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze].loadChatWithContext(e,s)}prepareDialogId(e){return babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze].prepareDialogId(e)}createChat(e){return babelHelpers.classPrivateFieldLooseBase(this,es)[es].createChat(e)}prepareAvatar(e){return babelHelpers.classPrivateFieldLooseBase(this,ss)[ss].prepareAvatar(e)}changeAvatar(e,s){return babelHelpers.classPrivateFieldLooseBase(this,ss)[ss].changeAvatar(e,s)}renameChat(e,s){return babelHelpers.classPrivateFieldLooseBase(this,as)[as].renameChat(e,s)}muteChat(e){babelHelpers.classPrivateFieldLooseBase(this,ts)[ts].muteChat(e)}unmuteChat(e){babelHelpers.classPrivateFieldLooseBase(this,ts)[ts].unmuteChat(e)}pinChat(e){babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].pinChat(e)}unpinChat(e){babelHelpers.classPrivateFieldLooseBase(this,rs)[rs].unpinChat(e)}readAll(){return babelHelpers.classPrivateFieldLooseBase(this,is)[is].readAll()}readDialog(e){babelHelpers.classPrivateFieldLooseBase(this,is)[is].readDialog(e)}unreadDialog(e){babelHelpers.classPrivateFieldLooseBase(this,is)[is].unreadDialog(e)}readMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,is)[is].readMessage(e,s)}clearDialogMark(e){babelHelpers.classPrivateFieldLooseBase(this,is)[is].clearDialogMark(e)}leaveChat(e){babelHelpers.classPrivateFieldLooseBase(this,ls)[ls].leaveChat(e)}kickUserFromChat(e,s){babelHelpers.classPrivateFieldLooseBase(this,ls)[ls].kickUserFromChat(e,s)}addToChat(e){return babelHelpers.classPrivateFieldLooseBase(this,ls)[ls].addToChat(e)}joinChat(e){babelHelpers.classPrivateFieldLooseBase(this,ls)[ls].joinChat(e)}}function cs(){babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze]=new Z;babelHelpers.classPrivateFieldLooseBase(this,es)[es]=new he;babelHelpers.classPrivateFieldLooseBase(this,ss)[ss]=new ue;babelHelpers.classPrivateFieldLooseBase(this,as)[as]=new He;babelHelpers.classPrivateFieldLooseBase(this,ts)[ts]=new Me;babelHelpers.classPrivateFieldLooseBase(this,rs)[rs]=new Oe;babelHelpers.classPrivateFieldLooseBase(this,is)[is]=new Ne;babelHelpers.classPrivateFieldLooseBase(this,ls)[ls]=new Je}ds.DEBOUNCE_TIME=500;var ns=babelHelpers.classPrivateFieldLooseKey("store");var bs=babelHelpers.classPrivateFieldLooseKey("restClient");var hs=babelHelpers.classPrivateFieldLooseKey("chatId");var vs=babelHelpers.classPrivateFieldLooseKey("userManager");var ps=babelHelpers.classPrivateFieldLooseKey("preparedHistoryMessages");var gs=babelHelpers.classPrivateFieldLooseKey("preparedUnreadMessages");var us=babelHelpers.classPrivateFieldLooseKey("isLoading");var Ps=babelHelpers.classPrivateFieldLooseKey("prepareInitialMessages");var Fs=babelHelpers.classPrivateFieldLooseKey("handleLoadedMessages");var Ls=babelHelpers.classPrivateFieldLooseKey("updateModels");var Hs=babelHelpers.classPrivateFieldLooseKey("setDialogInited");var fs=babelHelpers.classPrivateFieldLooseKey("getDialog");class Bs{constructor(e){Object.defineProperty(this,fs,{value:Cs});Object.defineProperty(this,Hs,{value:Ms});Object.defineProperty(this,Ls,{value:Is});Object.defineProperty(this,Fs,{value:ys});Object.defineProperty(this,Ps,{value:ms});Object.defineProperty(this,ns,{writable:true,value:void 0});Object.defineProperty(this,bs,{writable:true,value:void 0});Object.defineProperty(this,hs,{writable:true,value:void 0});Object.defineProperty(this,vs,{writable:true,value:void 0});Object.defineProperty(this,ps,{writable:true,value:[]});Object.defineProperty(this,gs,{writable:true,value:[]});Object.defineProperty(this,us,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,ns)[ns]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,bs)[bs]=g.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,vs)[vs]=new d.UserManager;babelHelpers.classPrivateFieldLooseBase(this,hs)[hs]=e}loadUnread(){if(babelHelpers.classPrivateFieldLooseBase(this,us)[us]||!babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().hasNextPage){return Promise.resolve(false)}v.Logger.warn("MessageService: loadUnread");const e=babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].getters["messages/getLastId"](babelHelpers.classPrivateFieldLooseBase(this,hs)[hs]);if(!e){v.Logger.warn("MessageService: no lastUnreadMessageId, cant load unread");return Promise.resolve(false)}babelHelpers.classPrivateFieldLooseBase(this,us)[us]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,hs)[hs],filter:{lastId:e},order:{id:"ASC"},limit:Bs.MESSAGE_REQUEST_LIMIT};return p.runAction(u.RestMethod.imV2ChatMessageTail,{data:s}).then((e=>{v.Logger.warn("MessageService: loadUnread result",e);babelHelpers.classPrivateFieldLooseBase(this,gs)[gs]=e.messages;return babelHelpers.classPrivateFieldLooseBase(this,Ls)[Ls](e)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,us)[us]=false;return true})).catch((e=>{console.error("MessageService: loadUnread error:",e);babelHelpers.classPrivateFieldLooseBase(this,us)[us]=false}))}loadHistory(){if(babelHelpers.classPrivateFieldLooseBase(this,us)[us]||!babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().hasPrevPage){return Promise.resolve(false)}v.Logger.warn("MessageService: loadHistory");const e=babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].getters["messages/getFirstId"](babelHelpers.classPrivateFieldLooseBase(this,hs)[hs]);if(!e){v.Logger.warn("MessageService: no lastHistoryMessageId, cant load unread");return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,us)[us]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,hs)[hs],filter:{lastId:e},order:{id:"DESC"},limit:Bs.MESSAGE_REQUEST_LIMIT};return p.runAction(u.RestMethod.imV2ChatMessageTail,{data:s}).then((e=>{v.Logger.warn("MessageService: loadHistory result",e);babelHelpers.classPrivateFieldLooseBase(this,ps)[ps]=e.messages;const s=e.hasNextPage;const a={...e,hasPrevPage:s,hasNextPage:null};return babelHelpers.classPrivateFieldLooseBase(this,Ls)[Ls](a)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,us)[us]=false;return true})).catch((e=>{console.error("MessageService: loadHistory error:",e);babelHelpers.classPrivateFieldLooseBase(this,us)[us]=false}))}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ps)[ps].length>0}drawPreparedHistoryMessages(){if(!this.hasPreparedHistoryMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,ps)[ps]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,ps)[ps]=[];return true}))}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,gs)[gs].length>0}drawPreparedUnreadMessages(){if(!this.hasPreparedUnreadMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,gs)[gs]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,gs)[gs]=[];return true}))}loadContext(e){const s={[u.RestMethod.imV2ChatMessageGetContext]:{id:e,range:Bs.MESSAGE_REQUEST_LIMIT},[u.RestMethod.imV2ChatMessageRead]:{chatId:babelHelpers.classPrivateFieldLooseBase(this,hs)[hs],ids:[e]}};v.Logger.warn("MessageService: loadContext for: ",e);babelHelpers.classPrivateFieldLooseBase(this,us)[us]=true;return p.callBatch(s).then((e=>{v.Logger.warn("MessageService: loadContext result",e);return babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs](e[u.RestMethod.imV2ChatMessageGetContext])})).catch((e=>{console.error("MessageService: loadContext error:",e);throw new Error(e)})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,us)[us]=false}))}reloadMessageList(){v.Logger.warn("MessageService: loadChatOnExit for: ",babelHelpers.classPrivateFieldLooseBase(this,hs)[hs]);let e=0;if(babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().chatId<=0){return Promise.resolve()}if(babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().markedId){e=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().markedId}else if(babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().savedPositionMessageId){e=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().savedPositionMessageId}const s=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().inited;babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs](false);if(e){return this.loadContext(e).catch((()=>{})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs](true,s)}))}return this.loadInitialMessages().catch((()=>{})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,Hs)[Hs](true,s)}))}async loadInitialMessages(){v.Logger.warn("MessageService: loadInitialMessages for: ",babelHelpers.classPrivateFieldLooseBase(this,hs)[hs]);babelHelpers.classPrivateFieldLooseBase(this,us)[us]=true;const e={data:{chatId:babelHelpers.classPrivateFieldLooseBase(this,hs)[hs],limit:Bs.MESSAGE_REQUEST_LIMIT}};const s=await p.runAction(u.RestMethod.imV2ChatMessageList,e).catch((e=>{console.error("MessageService: loadInitialMessages error:",e);babelHelpers.classPrivateFieldLooseBase(this,us)[us]=false;throw new Error(e)}));v.Logger.warn("MessageService: loadInitialMessages result",s);s.messages=babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps](s.messages);await babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs](s);babelHelpers.classPrivateFieldLooseBase(this,us)[us]=false}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,us)[us]}}function ms(e){if(e.length===0){return e}const s=babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().lastMessageId;const a=Math.max(...e.map((e=>e.id)));if(a>=s){return e}const t=babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].getters["messages/get"](babelHelpers.classPrivateFieldLooseBase(this,hs)[hs]);const r=t.filter((e=>e.id>a));v.Logger.warn("MessageService: loadInitialMessages: local id is higher than server one",r);return[...e,...r]}function ys(e){const{messages:s}=e;const a=babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].dispatch("messages/setChatCollection",{messages:s,clearCollection:true});const t=babelHelpers.classPrivateFieldLooseBase(this,Ls)[Ls](e);return Promise.all([a,t])}function Is(e){const{files:s,users:a,usersShort:t,reactions:r,hasPrevPage:i,hasNextPage:l,additionalMessages:o}=e;const d=babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().dialogId,fields:{hasPrevPage:i,hasNextPage:l}});const c=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,vs)[vs].setUsersToModel(a),babelHelpers.classPrivateFieldLooseBase(this,vs)[vs].addUsersToModel(t)]);const n=babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].dispatch("files/set",s);const b=babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].dispatch("messages/reactions/set",r);const h=babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].dispatch("messages/store",o);return Promise.all([d,n,c,b,h])}function Ms(e,s=true){const a={inited:e,loading:!e};if(e===true&&!s){delete a.inited}babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,fs)[fs]().dialogId,fields:a})}function Cs(){return babelHelpers.classPrivateFieldLooseBase(this,ns)[ns].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,hs)[hs])}Bs.MESSAGE_REQUEST_LIMIT=25;var ws=babelHelpers.classPrivateFieldLooseKey("store");var Ss=babelHelpers.classPrivateFieldLooseKey("restClient");class Os{constructor(){Object.defineProperty(this,ws,{writable:true,value:void 0});Object.defineProperty(this,Ss,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ws)[ws]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss]=g.Core.getRestClient()}pinMessage(e,s){v.Logger.warn(`Dialog: PinManager: pin message ${s}`);babelHelpers.classPrivateFieldLooseBase(this,ws)[ws].dispatch("messages/pin/add",{chatId:e,messageId:s});babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss].callMethod(u.RestMethod.imV2ChatMessagePin,{id:s}).catch((a=>{console.error("Dialog: PinManager: error pinning message",a);babelHelpers.classPrivateFieldLooseBase(this,ws)[ws].dispatch("messages/pin/delete",{chatId:e,messageId:s})}))}unpinMessage(e,s){v.Logger.warn(`Dialog: PinManager: unpin message ${s}`);babelHelpers.classPrivateFieldLooseBase(this,ws)[ws].dispatch("messages/pin/delete",{chatId:e,messageId:s});babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss].callMethod(u.RestMethod.imV2ChatMessageUnpin,{id:s}).catch((a=>{console.error("Dialog: PinManager: error unpinning message",a);babelHelpers.classPrivateFieldLooseBase(this,ws)[ws].dispatch("messages/pin/add",{chatId:e,messageId:s})}))}}var Us=babelHelpers.classPrivateFieldLooseKey("updateMessageModel");var js=babelHelpers.classPrivateFieldLooseKey("getMessage");class Rs{constructor(){Object.defineProperty(this,js,{value:Ks});Object.defineProperty(this,Us,{value:Es})}editMessageText(e,s){v.Logger.warn("MessageService: editMessageText",e,s);const a=babelHelpers.classPrivateFieldLooseBase(this,js)[js](e);if(!a){return}babelHelpers.classPrivateFieldLooseBase(this,Us)[Us](e,s);const t={data:{id:e,fields:{message:s}}};p.runAction(u.RestMethod.imV2ChatMessageUpdate,t).catch((e=>{v.Logger.error("MessageService: editMessageText error:",e)}))}}function Es(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,js)[js](e);const t=a.viewedByOthers;g.Core.getStore().dispatch("messages/update",{id:e,fields:{text:s,isEdited:t}})}function Ks(e){return g.Core.getStore().getters["messages/getById"](e)}var Ds=babelHelpers.classPrivateFieldLooseKey("store");var Ts=babelHelpers.classPrivateFieldLooseKey("chatId");var As=babelHelpers.classPrivateFieldLooseKey("shallowMessageDelete");var xs=babelHelpers.classPrivateFieldLooseKey("completeMessageDelete");var _s=babelHelpers.classPrivateFieldLooseKey("updateRecentForCompleteDelete");var ks=babelHelpers.classPrivateFieldLooseKey("updateChatForCompleteDelete");var Ns=babelHelpers.classPrivateFieldLooseKey("deleteMessageOnServer");var Vs=babelHelpers.classPrivateFieldLooseKey("deleteTemporaryMessage");var Xs=babelHelpers.classPrivateFieldLooseKey("getPreviousMessageId");var Gs=babelHelpers.classPrivateFieldLooseKey("sendDeleteEvent");class $s{constructor(e){Object.defineProperty(this,Gs,{value:ea});Object.defineProperty(this,Xs,{value:Zs});Object.defineProperty(this,Vs,{value:Js});Object.defineProperty(this,Ns,{value:Qs});Object.defineProperty(this,ks,{value:Ys});Object.defineProperty(this,_s,{value:zs});Object.defineProperty(this,xs,{value:qs});Object.defineProperty(this,As,{value:Ws});Object.defineProperty(this,Ds,{writable:true,value:void 0});Object.defineProperty(this,Ts,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts]=e;babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]=g.Core.getStore()}async deleteMessage(e){v.Logger.warn("MessageService: deleteMessage",e);if(n.Utils.text.isUuidV4(e)){babelHelpers.classPrivateFieldLooseBase(this,Vs)[Vs](e);return}babelHelpers.classPrivateFieldLooseBase(this,Gs)[Gs](e);const s=babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].getters["messages/getById"](e);if(s.viewedByOthers){await babelHelpers.classPrivateFieldLooseBase(this,As)[As](s)}else{await babelHelpers.classPrivateFieldLooseBase(this,xs)[xs](s)}}}function Ws(e){babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].dispatch("messages/update",{id:e.id,fields:{text:"",isDeleted:true,files:[],attach:[],replyId:0}});return babelHelpers.classPrivateFieldLooseBase(this,Ns)[Ns](e.id)}function qs(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts]);if(e.id===s.lastMessageId){const s=babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs](e.id);babelHelpers.classPrivateFieldLooseBase(this,_s)[_s](s);babelHelpers.classPrivateFieldLooseBase(this,ks)[ks](s)}babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].dispatch("messages/delete",{id:e.id});return babelHelpers.classPrivateFieldLooseBase(this,Ns)[Ns](e.id)}function zs(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts]);if(!e){babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].dispatch("recent/delete",{id:s.dialogId});return}babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].dispatch("recent/update",{id:s.dialogId,fields:{messageId:e}})}function Ys(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts]);babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].dispatch("chats/update",{dialogId:s.dialogId,fields:{lastMessageId:e,lastId:e}});babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].dispatch("chats/clearLastMessageViews",{dialogId:s.dialogId})}function Qs(e){return p.runAction(u.RestMethod.imV2ChatMessageDelete,{data:{id:e}}).catch((e=>{console.error("MessageService: deleteMessage error:",e)}))}function Js(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts]);const a=babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].getters["recent/get"](s.dialogId);if(a.messageId===e){const a=babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs](e);babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].dispatch("recent/update",{id:s.dialogId,fields:{messageId:a}})}babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].dispatch("messages/delete",{id:e})}function Zs(e){var s;const a=babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds].getters["messages/getPreviousMessage"]({messageId:e,chatId:babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts]});return(s=a==null?void 0:a.id)!=null?s:0}function ea(e){b.EventEmitter.emit(u.EventType.dialog.onMessageDeleted,{messageId:e})}var sa=babelHelpers.classPrivateFieldLooseKey("chatId");var aa=babelHelpers.classPrivateFieldLooseKey("store");var ta=babelHelpers.classPrivateFieldLooseKey("restClient");class ra{constructor(e){Object.defineProperty(this,sa,{writable:true,value:void 0});Object.defineProperty(this,aa,{writable:true,value:void 0});Object.defineProperty(this,ta,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,sa)[sa]=e;babelHelpers.classPrivateFieldLooseBase(this,aa)[aa]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ta)[ta]=g.Core.getRestClient()}markMessage(e){v.Logger.warn("MessageService: markMessage",e);const{dialogId:s}=babelHelpers.classPrivateFieldLooseBase(this,aa)[aa].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,sa)[sa]);babelHelpers.classPrivateFieldLooseBase(this,aa)[aa].dispatch("recent/unread",{id:s,action:true});babelHelpers.classPrivateFieldLooseBase(this,aa)[aa].dispatch("chats/update",{dialogId:s,fields:{markedId:e}});babelHelpers.classPrivateFieldLooseBase(this,ta)[ta].callMethod(u.RestMethod.imV2ChatMessageMark,{dialogId:s,id:e}).catch((e=>{console.error("MessageService: error marking message",e)}))}}var ia=babelHelpers.classPrivateFieldLooseKey("chatId");var la=babelHelpers.classPrivateFieldLooseKey("store");var oa=babelHelpers.classPrivateFieldLooseKey("restClient");class da{constructor(e){Object.defineProperty(this,ia,{writable:true,value:void 0});Object.defineProperty(this,la,{writable:true,value:void 0});Object.defineProperty(this,oa,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ia)[ia]=e;babelHelpers.classPrivateFieldLooseBase(this,la)[la]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,oa)[oa]=g.Core.getRestClient()}addMessageToFavorite(e){v.Logger.warn("MessageService: addMessageToFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].callMethod(u.RestMethod.imChatFavoriteAdd,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error adding message to favorite",e)}));BX.UI.Notification.Center.notify({content:o.Loc.getMessage("IM_MESSAGE_SERVICE_ADD_MESSAGE_TO_FAVORITE_SUCCESS")})}removeMessageFromFavorite(e){v.Logger.warn("MessageService: removeMessageFromFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,la)[la].dispatch("sidebar/favorites/deleteByMessageId",{chatId:babelHelpers.classPrivateFieldLooseBase(this,ia)[ia],messageId:e});babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].callMethod(u.RestMethod.imChatFavoriteDelete,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error removing message from favorite",e)}))}}var ca=babelHelpers.classPrivateFieldLooseKey("loadService");var na=babelHelpers.classPrivateFieldLooseKey("pinService");var ba=babelHelpers.classPrivateFieldLooseKey("editService");var ha=babelHelpers.classPrivateFieldLooseKey("deleteService");var va=babelHelpers.classPrivateFieldLooseKey("markService");var pa=babelHelpers.classPrivateFieldLooseKey("favoriteService");var ga=babelHelpers.classPrivateFieldLooseKey("initServices");class ua{static getMessageRequestLimit(){return Bs.MESSAGE_REQUEST_LIMIT}constructor(e){Object.defineProperty(this,ga,{value:Pa});Object.defineProperty(this,ca,{writable:true,value:void 0});Object.defineProperty(this,na,{writable:true,value:void 0});Object.defineProperty(this,ba,{writable:true,value:void 0});Object.defineProperty(this,ha,{writable:true,value:void 0});Object.defineProperty(this,va,{writable:true,value:void 0});Object.defineProperty(this,pa,{writable:true,value:void 0});const{chatId:s}=e;babelHelpers.classPrivateFieldLooseBase(this,ga)[ga](s)}loadUnread(){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].loadUnread()}loadHistory(){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].loadHistory()}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].hasPreparedHistoryMessages()}drawPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].drawPreparedHistoryMessages()}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].hasPreparedUnreadMessages()}drawPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].drawPreparedUnreadMessages()}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].isLoading()}loadContext(e){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].loadContext(e)}reloadMessageList(){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].reloadMessageList()}loadInitialMessages(){return babelHelpers.classPrivateFieldLooseBase(this,ca)[ca].loadInitialMessages()}pinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,na)[na].pinMessage(e,s)}unpinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,na)[na].unpinMessage(e,s)}markMessage(e){babelHelpers.classPrivateFieldLooseBase(this,va)[va].markMessage(e)}addMessageToFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].addMessageToFavorite(e)}removeMessageFromFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,pa)[pa].removeMessageFromFavorite(e)}editMessageText(e,s){babelHelpers.classPrivateFieldLooseBase(this,ba)[ba].editMessageText(e,s)}deleteMessage(e){babelHelpers.classPrivateFieldLooseBase(this,ha)[ha].deleteMessage(e)}}function Pa(e){babelHelpers.classPrivateFieldLooseBase(this,ca)[ca]=new Bs(e);babelHelpers.classPrivateFieldLooseBase(this,ba)[ba]=new Rs;babelHelpers.classPrivateFieldLooseBase(this,ha)[ha]=new $s(e);babelHelpers.classPrivateFieldLooseBase(this,na)[na]=new Os;babelHelpers.classPrivateFieldLooseBase(this,va)[va]=new ra(e);babelHelpers.classPrivateFieldLooseBase(this,pa)[pa]=new da(e)}var Fa=babelHelpers.classPrivateFieldLooseKey("store");var La=babelHelpers.classPrivateFieldLooseKey("prepareMessage");var Ha=babelHelpers.classPrivateFieldLooseKey("prepareMessageWithFile");var fa=babelHelpers.classPrivateFieldLooseKey("handlePagination");var Ba=babelHelpers.classPrivateFieldLooseKey("addMessageToModels");var ma=babelHelpers.classPrivateFieldLooseKey("addMessageToRecent");var ya=babelHelpers.classPrivateFieldLooseKey("sendMessageToServer");var Ia=babelHelpers.classPrivateFieldLooseKey("updateModels");var Ma=babelHelpers.classPrivateFieldLooseKey("updateMessageError");var Ca=babelHelpers.classPrivateFieldLooseKey("sendScrollEvent");var wa=babelHelpers.classPrivateFieldLooseKey("getDialog");var Sa=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");var Oa=babelHelpers.classPrivateFieldLooseKey("needToSetAsViewed");var Ua=babelHelpers.classPrivateFieldLooseKey("handleForwardMessageResponse");var ja=babelHelpers.classPrivateFieldLooseKey("handleForwardMessageError");var Ra=babelHelpers.classPrivateFieldLooseKey("prepareForwardMessages");var Ea=babelHelpers.classPrivateFieldLooseKey("prepareSendForwardRequest");var Ka=babelHelpers.classPrivateFieldLooseKey("addForwardsToModels");var Da=babelHelpers.classPrivateFieldLooseKey("getForwardUuidMap");var Ta=babelHelpers.classPrivateFieldLooseKey("buildForwardContextId");var Aa=babelHelpers.classPrivateFieldLooseKey("logSendErrors");class xa{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,Aa,{value:it});Object.defineProperty(this,Ta,{value:rt});Object.defineProperty(this,Da,{value:tt});Object.defineProperty(this,Ka,{value:at});Object.defineProperty(this,Ea,{value:st});Object.defineProperty(this,Ra,{value:et});Object.defineProperty(this,ja,{value:Za});Object.defineProperty(this,Ua,{value:Ja});Object.defineProperty(this,Oa,{value:Qa});Object.defineProperty(this,Sa,{value:Ya});Object.defineProperty(this,wa,{value:za});Object.defineProperty(this,Ca,{value:qa});Object.defineProperty(this,Ma,{value:Wa});Object.defineProperty(this,Ia,{value:$a});Object.defineProperty(this,ya,{value:Ga});Object.defineProperty(this,ma,{value:Xa});Object.defineProperty(this,Ba,{value:Va});Object.defineProperty(this,fa,{value:Na});Object.defineProperty(this,Ha,{value:ka});Object.defineProperty(this,La,{value:_a});Object.defineProperty(this,Fa,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa]=g.Core.getStore()}async sendMessage(e){const{text:s="",dialogId:a}=e;if(!o.Type.isStringFilled(s)){return Promise.resolve()}v.Logger.warn("SendingService: sendMessage",e);const t=babelHelpers.classPrivateFieldLooseBase(this,La)[La](e);await babelHelpers.classPrivateFieldLooseBase(this,fa)[fa](a);await babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](t);babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca]({force:true,dialogId:a});const r=await babelHelpers.classPrivateFieldLooseBase(this,ya)[ya](t).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma](t.temporaryId);babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa](e,"sendMessage")}));v.Logger.warn("SendingService: sendMessage result -",r);const{id:i}=r;if(!i){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,Ia)[Ia]({oldId:t.temporaryId,newId:i,dialogId:t.dialogId});return Promise.resolve()}async sendMessageWithFile(e){const{text:s="",fileId:a="",dialogId:t}=e;if(!o.Type.isStringFilled(s)&&!o.Type.isStringFilled(a)){return Promise.resolve()}v.Logger.warn("SendingService: sendMessage with file",e);const r=babelHelpers.classPrivateFieldLooseBase(this,Ha)[Ha](e);await babelHelpers.classPrivateFieldLooseBase(this,fa)[fa](t);await babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](r);babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca]({force:true,dialogId:t});return Promise.resolve()}async forwardMessages(e){v.Logger.warn("SendingService: forwardMessages",e);const{forwardIds:s,dialogId:a,text:t}=e;if(!o.Type.isArrayFilled(s)){return Promise.resolve()}await babelHelpers.classPrivateFieldLooseBase(this,fa)[fa](a);let r=null;if(o.Type.isStringFilled(t)){r=babelHelpers.classPrivateFieldLooseBase(this,La)[La](e);await babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](r)}const i=babelHelpers.classPrivateFieldLooseBase(this,Da)[Da](s);const l=babelHelpers.classPrivateFieldLooseBase(this,Ra)[Ra](e,i);await babelHelpers.classPrivateFieldLooseBase(this,Ka)[Ka](l);babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca]({force:true,dialogId:a});try{const e=babelHelpers.classPrivateFieldLooseBase(this,Ea)[Ea]({forwardUuidMap:i,commentMessage:r,dialogId:a});const s=await babelHelpers.classPrivateFieldLooseBase(this,ya)[ya](e);v.Logger.warn("SendingService: forwardMessage result -",s);babelHelpers.classPrivateFieldLooseBase(this,Ua)[Ua]({response:s,dialogId:a,commentMessage:r})}catch(e){babelHelpers.classPrivateFieldLooseBase(this,ja)[ja]({commentMessage:r,forwardUuidMap:i});babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa](e,"forwardMessage")}return Promise.resolve()}async retrySendMessage(e){const{tempMessageId:s,dialogId:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].getters["messages/getById"](s);if(!t){return Promise.resolve()}void babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("messages/update",{id:s,fields:{sending:true,error:false}});const r=babelHelpers.classPrivateFieldLooseBase(this,La)[La]({text:t.text,dialogId:a,tempMessageId:t.id,replyId:t.replyId});const i=await babelHelpers.classPrivateFieldLooseBase(this,ya)[ya](r).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Ma)[Ma](r.temporaryId);babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa](e,"retrySendMessage")}));v.Logger.warn("SendingService: retrySendMessage result -",i.data());const{id:l}=i.data();if(!l){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,Ia)[Ia]({oldId:r.temporaryId,newId:l,dialogId:r.dialogId});return Promise.resolve()}}function _a(e){const{text:s,tempMessageId:a,dialogId:t,replyId:r,forwardIds:i}=e;const l={authorId:g.Core.getUserId(),unread:false,sending:true};return{text:s,dialogId:t,chatId:babelHelpers.classPrivateFieldLooseBase(this,wa)[wa](t).chatId,temporaryId:a!=null?a:n.Utils.text.getUuidV4(),replyId:r,forwardIds:i,viewedByOthers:babelHelpers.classPrivateFieldLooseBase(this,Oa)[Oa](t),...l}}function ka(e){const{fileId:s}=e;if(!s){throw new Error("SendingService: sendMessageWithFile: no fileId provided")}return{...babelHelpers.classPrivateFieldLooseBase(this,La)[La](e),params:{FILE_ID:[s]}}}function Na(e){if(!babelHelpers.classPrivateFieldLooseBase(this,wa)[wa](e).hasNextPage){return Promise.resolve()}v.Logger.warn("SendingService: sendMessage: there are unread pages, move to chat end");const s=new ua({chatId:babelHelpers.classPrivateFieldLooseBase(this,wa)[wa](e).chatId});return s.loadContext(babelHelpers.classPrivateFieldLooseBase(this,wa)[wa](e).lastMessageId).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,Ca)[Ca]({dialogId:e})})).catch((e=>{console.error("SendingService: loadContext error",e)}))}function Va(e){babelHelpers.classPrivateFieldLooseBase(this,ma)[ma](e);babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("chats/clearLastMessageViews",{dialogId:e.dialogId});return babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("messages/add",e)}function Xa(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].getters["recent/get"](e.dialogId);if(!s||e.text===""){return}babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("recent/update",{id:e.dialogId,fields:{messageId:e.temporaryId}})}function Ga(e){const s={};if(e.replyId){s.replyId=e.replyId}if(e.forwardIds){s.forwardIds=e.forwardIds}if(e.text){s.message=e.text;s.templateId=e.temporaryId}const a={dialogId:e.dialogId.toString(),fields:s};return p.runAction(u.RestMethod.imV2ChatMessageSend,{data:a})}function $a(e){const{oldId:s,newId:a,dialogId:t}=e;babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("messages/updateWithId",{id:s,fields:{id:a}});babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("chats/update",{dialogId:t,fields:{lastId:a,lastMessageId:a}});babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("recent/update",{id:t,fields:{messageId:a}})}function Wa(e){babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("messages/update",{id:e,fields:{error:true}})}function qa(e={}){const{force:s=false,dialogId:a}=e;b.EventEmitter.emit(u.EventType.dialog.scrollToBottom,{chatId:babelHelpers.classPrivateFieldLooseBase(this,wa)[wa](a).chatId,threshold:s?u.DialogScrollThreshold.none:u.DialogScrollThreshold.halfScreenUp})}function za(e){return babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].getters["chats/get"](e,true)}function Ya(e){return babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].getters["chats/getByChatId"](e,true)}function Qa(e){return babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].getters["users/bots/isNetwork"](e)}function Ja(e){const{response:s,dialogId:a,commentMessage:t}=e;const{id:r,uuidMap:i}=s;if(r){babelHelpers.classPrivateFieldLooseBase(this,Ia)[Ia]({oldId:t.temporaryId,newId:r,dialogId:a})}Object.entries(i).forEach((([e,s])=>{babelHelpers.classPrivateFieldLooseBase(this,Ia)[Ia]({oldId:e,newId:s,dialogId:a})}))}function Za({commentMessage:e,forwardUuidMap:s}){if(e){babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("messages/update",{id:e.temporaryId,fields:{error:true}})}Object.keys(s).forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].dispatch("messages/update",{id:e,fields:{error:true}})}))}function et(e,s){const{forwardIds:a,dialogId:t}=e;if(a.length===0){return[]}const r=[];Object.entries(s).forEach((([e,s])=>{const a=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].getters["messages/getById"](s);if(!a){return}const i=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa].getters["messages/isForward"](s);r.push({...babelHelpers.classPrivateFieldLooseBase(this,La)[La]({dialogId:t,text:a.text,tempMessageId:e,replyId:a.replyId}),forward:{id:babelHelpers.classPrivateFieldLooseBase(this,Ta)[Ta](a.chatId,s),userId:i?a.forward.userId:a.authorId},attach:a.attach,isDeleted:a.isDeleted,files:a.files})}));return r}function st(e){const{dialogId:s,forwardUuidMap:a,commentMessage:t}=e;const r={dialogId:s,forwardIds:a};if(t){r.text=t.text;r.temporaryId=t.temporaryId}return r}function at(e){const s=[];e.forEach((e=>{s.push(babelHelpers.classPrivateFieldLooseBase(this,Ba)[Ba](e))}));return Promise.all(s)}function tt(e){const s={};e.forEach((e=>{s[n.Utils.text.getUuidV4()]=e}));return s}function rt(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,Sa)[Sa](e).dialogId;if(a.startsWith("chat")){return`${a}/${s}`}const t=g.Core.getUserId();return`${a}:${t}/${s}`}function it(e,s){e.forEach((e=>{console.error(`SendingService: ${s} error: code: ${e.code} message: ${e.message}`)}))}xa.instance=null;class lt{constructor(){this.store=null;this.restClient=null;this.limitPerPage=50;this.isLoading=false;this.lastId=0;this.lastType=0;this.hasMoreItemsToLoad=true;this.notificationsToDelete=new Set;this.store=g.Core.getStore();this.restClient=g.Core.getRestClient();this.deleteWithDebounce=o.Runtime.debounce(this.deleteRequest,500,this);this.userManager=new d.UserManager}loadFirstPage(){this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}delete(e){this.notificationsToDelete.add(e);this.store.dispatch("notifications/delete",{id:e});this.store.dispatch("notifications/deleteFromSearch",{id:e});this.deleteWithDebounce()}sendConfirmAction(e,s){const a={NOTIFY_ID:e,NOTIFY_VALUE:s};this.store.dispatch("notifications/delete",{id:e});this.restClient.callMethod("im.notify.confirm",a).then((e=>{v.Logger.warn(`NotificationService: sendConfirmAction: success`,e)})).catch((e=>{console.error(e)}))}sendQuickAnswer(e){const{id:s,text:a,callbackSuccess:t=(()=>{}),callbackError:r=(()=>{})}=e;this.restClient.callMethod(u.RestMethod.imNotifyAnswer,{notify_id:s,answer_text:a}).then((e=>{t(e)})).catch((e=>{console.error(e);r()}))}deleteRequest(){const e=[...this.notificationsToDelete];this.restClient.callMethod("im.notify.delete",{id:e}).then((s=>{v.Logger.warn(`NotificationService: deleteRequest: success for ids: ${e}`,s)})).catch((e=>{console.error(e)}));this.notificationsToDelete.clear()}requestItems({firstPage:e=false}={}){const s={LIMIT:this.limitPerPage,CONVERT_TEXT:"Y"};const a={[u.RestMethod.imNotifyGet]:[u.RestMethod.imNotifyGet,s]};if(!e){s.LAST_ID=this.lastId;s.LAST_TYPE=this.lastType}else{a[u.RestMethod.imNotifySchemaGet]=[u.RestMethod.imNotifySchemaGet,{}]}return new Promise((e=>{this.restClient.callBatch(a,(s=>{v.Logger.warn("im.notify.get: result",s);e(this.handleResponse(s))}))}))}handleResponse(e){const s=e[u.RestMethod.imNotifyGet].data();this.hasMoreItemsToLoad=!this.isLastPage(s.notifications);if(s.notifications.length===0){v.Logger.warn("im.notify.get: no notifications",s);return Promise.resolve()}this.lastId=this.getLastItemId(s.notifications);this.lastType=this.getLastItemType(s.notifications);return this.updateModels(s).then((()=>{this.isLoading=false;if(e[u.RestMethod.imNotifySchemaGet]){return e[u.RestMethod.imNotifySchemaGet].data()}return{}}))}updateModels(e){this.userManager.setUsersToModel(e.users);return this.store.dispatch("notifications/initialSet",e)}getLastItemId(e){return e[e.length-1].id}getLastItemType(e){return this.getItemType(e[e.length-1])}getItemType(e){return e.notify_type===u.NotificationTypesCodes.confirm?u.NotificationTypesCodes.confirm:u.NotificationTypesCodes.simple}isLastPage(e){if(!o.Type.isArrayFilled(e)||e.length<this.limitPerPage){return true}return false}destroy(){v.Logger.warn("Notification service destroyed")}}var ot=babelHelpers.classPrivateFieldLooseKey("restClient");class dt{constructor(){Object.defineProperty(this,ot,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ot)[ot]=g.Core.getRestClient()}delete({chatId:e,fileId:s}){const a={chat_id:e,file_id:s};return babelHelpers.classPrivateFieldLooseBase(this,ot)[ot].callMethod(u.RestMethod.imDiskFileDelete,a).catch((e=>{console.error("DiskService: error deleting file",e)}))}save(e){const s={file_id:e};return babelHelpers.classPrivateFieldLooseBase(this,ot)[ot].callMethod(u.RestMethod.imDiskFileSave,s).catch((e=>{console.error("DiskService: error saving file on disk",e)}))}}class ct extends V{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getCollection(){return this.store.getters["recent/getUnreadCollection"]}loadFirstPage({ignorePreloadedItems:e=false}={}){this.isLoading=true;return this.requestItems({firstPage:true})}updateModels(e){const{users:s,dialogues:a,recent:t}=this.prepareDataForModels(e);const r=this.store.dispatch("users/set",s);const i=this.store.dispatch("chats/set",a);const l=this.getFakeData(t);const o=this.store.dispatch("recent/setUnread",l);return Promise.all([r,i,o])}getFakeData(e){e=e.slice(-4);e.forEach((e=>{this.store.dispatch("chats/update",{dialogId:e.id,fields:{counter:7}})}));return e}onUpdateState({data:e}){}}ct.instance=null;var nt=babelHelpers.classPrivateFieldLooseKey("uploaderRegistry");var bt=babelHelpers.classPrivateFieldLooseKey("onUploadCancelHandler");var ht=babelHelpers.classPrivateFieldLooseKey("addFile");var vt=babelHelpers.classPrivateFieldLooseKey("onUploadCancel");var pt=babelHelpers.classPrivateFieldLooseKey("removeFileFromUploader");class gt extends b.EventEmitter{constructor(){super();Object.defineProperty(this,pt,{value:Ft});Object.defineProperty(this,vt,{value:Pt});Object.defineProperty(this,ht,{value:ut});Object.defineProperty(this,nt,{writable:true,value:{}});Object.defineProperty(this,bt,{writable:true,value:void 0});this.setEventNamespace(gt.eventNamespace);babelHelpers.classPrivateFieldLooseBase(this,bt)[bt]=babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].bind(this);b.EventEmitter.subscribe(u.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,bt)[bt])}createUploader(e){const{diskFolderId:s,uploaderId:a,autoUpload:t}=e;babelHelpers.classPrivateFieldLooseBase(this,nt)[nt][a]=new h.Uploader({autoUpload:t,controller:"disk.uf.integration.diskUploaderController",multiple:true,controllerOptions:{folderId:s},imageResizeWidth:1280,imageResizeHeight:1280,imageResizeMode:"contain",imageResizeFilter:e=>!e.getCustomData("sendAsFile")&&e.getExtension()!=="gif",imageResizeMimeType:"image/jpeg",imageResizeMimeTypeMode:"force",imagePreviewHeight:720,imagePreviewWidth:720,treatOversizeImageAsFile:true,ignoreUnknownImageTypes:true,maxFileSize:null,events:{[h.UploaderEvent.FILE_ADD_START]:e=>{this.emit(gt.events.onFileAddStart,e)},[h.UploaderEvent.FILE_UPLOAD_START]:e=>{this.emit(gt.events.onFileUploadStart,e)},[h.UploaderEvent.FILE_ADD]:e=>{const{file:s}=e.getData();this.emit(gt.events.onFileAdd,{file:s,uploaderId:a})},[h.UploaderEvent.FILE_UPLOAD_PROGRESS]:e=>{this.emit(gt.events.onFileUploadProgress,e)},[h.UploaderEvent.FILE_UPLOAD_COMPLETE]:e=>{const{file:s}=e.getData();this.emit(gt.events.onFileUploadComplete,{file:s,uploaderId:a})},[h.UploaderEvent.ERROR]:e=>{this.emit(gt.events.onFileUploadError,e)},[h.UploaderEvent.FILE_ERROR]:e=>{this.emit(gt.events.onFileUploadError,e)},[h.UploaderEvent.MAX_FILE_COUNT_EXCEEDED]:e=>{this.emit(gt.events.onMaxFileCountExceeded,e)},[h.UploaderEvent.UPLOAD_COMPLETE]:()=>{babelHelpers.classPrivateFieldLooseBase(this,nt)[nt][a].destroy({removeFilesFromServer:false})}}})}start(e){babelHelpers.classPrivateFieldLooseBase(this,nt)[nt][e].setAutoUpload(true);babelHelpers.classPrivateFieldLooseBase(this,nt)[nt][e].start()}addFiles(e){const s=[];e.forEach((e=>{const a=babelHelpers.classPrivateFieldLooseBase(this,ht)[ht](e);if(a){s.push(a)}}));return s}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,nt)[nt][e].getFiles()}destroy(){b.EventEmitter.unsubscribe(u.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,bt)[bt])}}function ut(e){return babelHelpers.classPrivateFieldLooseBase(this,nt)[nt][e.uploaderId].addFile(e.file,{id:e.tempFileId,customData:{dialogId:e.dialogId,chatId:e.chatId,tempMessageId:e.tempMessageId,sendAsFile:e.sendAsFile}})}function Pt(e){const{tempFileId:s,tempMessageId:a}=e.getData();if(!s||!a){return}babelHelpers.classPrivateFieldLooseBase(this,pt)[pt](s);this.emit(gt.events.onFileUploadCancel,{tempMessageId:a,tempFileId:s})}function Ft(e){const s=Object.values(babelHelpers.classPrivateFieldLooseBase(this,nt)[nt]);for(const a of s){if(!a.getFile){continue}const s=a.getFile(e);if(s){s.remove();break}}}gt.eventNamespace="BX.Messenger.v2.Service.Uploading.UploaderWrapper";gt.events={onFileAddStart:"onFileAddStart",onFileAdd:"onFileAdd",onFileUploadStart:"onFileUploadStart",onFileUploadProgress:"onFileUploadProgress",onFileUploadComplete:"onFileUploadComplete",onFileUploadError:"onFileUploadError",onFileUploadCancel:"onFileUploadCancel",onMaxFileCountExceeded:"onMaxFileCountExceeded"};var Lt=babelHelpers.classPrivateFieldLooseKey("store");var Ht=babelHelpers.classPrivateFieldLooseKey("restClient");var ft=babelHelpers.classPrivateFieldLooseKey("isRequestingDiskFolderId");var Bt=babelHelpers.classPrivateFieldLooseKey("diskFolderIdRequestPromise");var mt=babelHelpers.classPrivateFieldLooseKey("uploaderWrapper");var yt=babelHelpers.classPrivateFieldLooseKey("sendingService");var It=babelHelpers.classPrivateFieldLooseKey("uploaderFilesRegistry");var Mt=babelHelpers.classPrivateFieldLooseKey("createUploader");var Ct=babelHelpers.classPrivateFieldLooseKey("addFileFromDiskToModel");var wt=babelHelpers.classPrivateFieldLooseKey("initUploader");var St=babelHelpers.classPrivateFieldLooseKey("requestDiskFolderId");var Ot=babelHelpers.classPrivateFieldLooseKey("uploadPreview");var Ut=babelHelpers.classPrivateFieldLooseKey("prepareMessageWithFile");var jt=babelHelpers.classPrivateFieldLooseKey("updateFileProgress");var Rt=babelHelpers.classPrivateFieldLooseKey("cancelUpload");var Et=babelHelpers.classPrivateFieldLooseKey("addFileToStore");var Kt=babelHelpers.classPrivateFieldLooseKey("updateFilePreviewInStore");var Dt=babelHelpers.classPrivateFieldLooseKey("updateFileSizeInStore");var Tt=babelHelpers.classPrivateFieldLooseKey("preparePreview");var At=babelHelpers.classPrivateFieldLooseKey("getDiskFolderId");var xt=babelHelpers.classPrivateFieldLooseKey("getFileType");var _t=babelHelpers.classPrivateFieldLooseKey("getFileExtension");var kt=babelHelpers.classPrivateFieldLooseKey("getDialog");var Nt=babelHelpers.classPrivateFieldLooseKey("getCurrentUser");var Vt=babelHelpers.classPrivateFieldLooseKey("getChatId");var Xt=babelHelpers.classPrivateFieldLooseKey("registerFiles");var Gt=babelHelpers.classPrivateFieldLooseKey("setReadyFilePreview");var $t=babelHelpers.classPrivateFieldLooseKey("setMessagesText");var Wt=babelHelpers.classPrivateFieldLooseKey("setAutoUpload");var qt=babelHelpers.classPrivateFieldLooseKey("createMessagesFromFiles");var zt=babelHelpers.classPrivateFieldLooseKey("readyToAddMessages");var Yt=babelHelpers.classPrivateFieldLooseKey("tryToSendMessages");var Qt=babelHelpers.classPrivateFieldLooseKey("prepareFileFromDisk");var Jt=babelHelpers.classPrivateFieldLooseKey("showError");var Zt=babelHelpers.classPrivateFieldLooseKey("setMessageError");class er{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,Zt,{value:wr});Object.defineProperty(this,Jt,{value:Cr});Object.defineProperty(this,Qt,{value:Mr});Object.defineProperty(this,Yt,{value:Ir});Object.defineProperty(this,zt,{value:yr});Object.defineProperty(this,qt,{value:mr});Object.defineProperty(this,Wt,{value:Br});Object.defineProperty(this,$t,{value:fr});Object.defineProperty(this,Gt,{value:Hr});Object.defineProperty(this,Xt,{value:Lr});Object.defineProperty(this,Vt,{value:Fr});Object.defineProperty(this,Nt,{value:Pr});Object.defineProperty(this,kt,{value:ur});Object.defineProperty(this,_t,{value:gr});Object.defineProperty(this,xt,{value:pr});Object.defineProperty(this,At,{value:vr});Object.defineProperty(this,Tt,{value:hr});Object.defineProperty(this,Dt,{value:br});Object.defineProperty(this,Kt,{value:nr});Object.defineProperty(this,Et,{value:cr});Object.defineProperty(this,Rt,{value:dr});Object.defineProperty(this,jt,{value:or});Object.defineProperty(this,Ut,{value:lr});Object.defineProperty(this,Ot,{value:ir});Object.defineProperty(this,St,{value:rr});Object.defineProperty(this,wt,{value:tr});Object.defineProperty(this,Ct,{value:ar});Object.defineProperty(this,Mt,{value:sr});Object.defineProperty(this,Lt,{writable:true,value:void 0});Object.defineProperty(this,Ht,{writable:true,value:void 0});Object.defineProperty(this,ft,{writable:true,value:false});Object.defineProperty(this,Bt,{writable:true,value:{}});Object.defineProperty(this,mt,{writable:true,value:void 0});Object.defineProperty(this,yt,{writable:true,value:void 0});Object.defineProperty(this,It,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht]=g.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,yt)[yt]=xa.getInstance();babelHelpers.classPrivateFieldLooseBase(this,wt)[wt]()}addFilesFromClipboard(e,s){return h.getFilesFromDataTransfer(e).then((e=>{const a=e.filter((e=>n.Utils.file.isImage(e.name)));if(a.length===0){return{files:[],uploaderId:""}}return this.addFiles({files:a,dialogId:s,autoUpload:false})}))}addFilesFromInput(e,s,a){if(e.length===0){return}this.addFiles({files:e,dialogId:s,autoUpload:true,sendAsFile:a}).then((({uploaderId:e})=>{babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt](e)})).catch((e=>{v.Logger.error("SendingService: sendFilesFromInput error",e)}))}addFiles(e){const{files:s,dialogId:a,autoUpload:t,sendAsFile:r=false}=e;return babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt]({dialogId:a,autoUpload:t}).then((e=>{const i=[];s.forEach((s=>{const t=babelHelpers.classPrivateFieldLooseBase(this,Ut)[Ut](s,a,e,r);i.push(t)}));const l=babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].addFiles(i);babelHelpers.classPrivateFieldLooseBase(this,Xt)[Xt](e,l,a,t);return{files:l,uploaderId:e}}))}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].getFiles(e)}start(e){babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].autoUpload=true;babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].start(e)}uploadFileFromDisk(e,s){Object.values(e).forEach((e=>{const a=babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt](e,s);babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct](a).then((()=>{const e={tempMessageId:a.tempMessageId,fileId:a.tempFileId,dialogId:a.dialogId};return babelHelpers.classPrivateFieldLooseBase(this,yt)[yt].sendMessageWithFile(e)})).then((()=>{this.commitFile({chatId:a.chatId,temporaryFileId:a.tempFileId,tempMessageId:a.tempMessageId,realFileId:a.file.id.slice(1),fromDisk:true})})).catch((e=>{console.error("SendingService: sendFilesFromDisk error:",e)}))}))}checkDiskFolderId(e){if(babelHelpers.classPrivateFieldLooseBase(this,At)[At](e)>0){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,At)[At](e))}if(babelHelpers.classPrivateFieldLooseBase(this,ft)[ft]){return babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt][e]}babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt][e]=babelHelpers.classPrivateFieldLooseBase(this,St)[St](e);return babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt][e]}commitFile(e){const{temporaryFileId:s,tempMessageId:a,chatId:t,realFileId:r,fromDisk:i,messageText:l="",sendAsFile:o=false}=e;const d={};if(i){d.disk_id=r}else{d.upload_id=r.toString().slice(1)}babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht].callMethod(u.RestMethod.imDiskFileCommit,{chat_id:t,message:l,template_id:a,file_template_id:s,as_file:o?"Y":"N",...d}).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Zt)[Zt](a);babelHelpers.classPrivateFieldLooseBase(this,jt)[jt](s,0,u.FileStatus.error);v.Logger.error("commitFile error",e)}))}sendSeparateMessagesWithFiles(e){const{uploaderId:s,text:a}=e;babelHelpers.classPrivateFieldLooseBase(this,$t)[$t](s,a);babelHelpers.classPrivateFieldLooseBase(this,Wt)[Wt](s,true);babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt](s)}destroy(){babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].destroy()}}function sr(e){const{dialogId:s,autoUpload:a}=e;const t=n.Utils.text.getUuidV4();return this.checkDiskFolderId(s).then((e=>{babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].createUploader({diskFolderId:e,uploaderId:t,autoUpload:a});return t}))}function ar(e){return babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].dispatch("files/add",{id:e.tempFileId,chatId:e.chatId,authorId:g.Core.getUserId(),name:e.file.name,type:n.Utils.file.getFileTypeByExtension(e.file.ext),extension:e.file.ext,size:e.file.sizeInt,status:u.FileStatus.wait,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,Nt)[Nt]().name})}function tr(){babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]=new gt;babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].subscribe(gt.events.onFileAddStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Et)[Et](s)}));babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].subscribe(gt.events.onFileAdd,(e=>{const{file:s,uploaderId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Kt)[Kt](s);babelHelpers.classPrivateFieldLooseBase(this,Gt)[Gt](a,s.getId());babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt](a)}));babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].subscribe(gt.events.onFileUploadStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Dt)[Dt](s)}));babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].subscribe(gt.events.onFileUploadProgress,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,jt)[jt](s.getId(),s.getProgress(),u.FileStatus.upload)}));babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].subscribe(gt.events.onFileUploadComplete,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,jt)[jt](s.getId(),s.getProgress(),u.FileStatus.wait);babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot](s).then((()=>{var e;this.commitFile({realFileId:s.getServerFileId(),temporaryFileId:s.getId(),chatId:s.getCustomData("chatId"),tempMessageId:s.getCustomData("tempMessageId"),messageText:(e=s.getCustomData("messageText"))!=null?e:"",sendAsFile:s.getCustomData("sendAsFile"),fromDisk:false})})).catch((e=>{v.Logger.warn("UploadingService: upload preview error",e)}))}));babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].subscribe(gt.events.onFileUploadError,(e=>{const{file:s,error:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,jt)[jt](s.getId(),0,u.FileStatus.error);babelHelpers.classPrivateFieldLooseBase(this,Zt)[Zt](s.getCustomData("tempMessageId"));babelHelpers.classPrivateFieldLooseBase(this,Jt)[Jt](a);v.Logger.error("UploadingService: upload error",a)}));babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].subscribe(gt.events.onFileUploadCancel,(e=>{const{tempMessageId:s,tempFileId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt](s,a)}))}function rr(e){return new Promise(((s,a)=>{babelHelpers.classPrivateFieldLooseBase(this,ft)[ft]=true;const t=babelHelpers.classPrivateFieldLooseBase(this,Vt)[Vt](e);babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht].callMethod(u.RestMethod.imDiskFolderGet,{chat_id:t}).then((a=>{const{ID:t}=a.data();babelHelpers.classPrivateFieldLooseBase(this,ft)[ft]=false;babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].commit("chats/update",{dialogId:e,fields:{diskFolderId:t}});s(t)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,ft)[ft]=false;a(e)}))}))}function ir(e){if(babelHelpers.classPrivateFieldLooseBase(this,xt)[xt](e.getBinary())===u.FileType.file||e.getExtension()==="gif"){return Promise.resolve()}const s=e.getServerFileId().toString().slice(1);const a=e.getClientPreview();if(!a){e.setCustomData("sendAsFile",true);return Promise.resolve()}const t=new FormData;t.append("id",s);t.append("previewFile",a,`preview_${e.getName()}.jpg`);return p.runAction(u.RestMethod.imDiskFilePreviewUpload,{data:t}).catch((e=>{v.Logger.error("imDiskFilePreviewUpload request error",e)}))}function lr(e,s,a,t){const r=n.Utils.text.getUuidV4();const i=n.Utils.text.getUuidV4();const l=babelHelpers.classPrivateFieldLooseBase(this,Vt)[Vt](s);return{tempMessageId:r,tempFileId:i,file:e,dialogId:s,chatId:l,uploaderId:a,sendAsFile:t&&babelHelpers.classPrivateFieldLooseBase(this,xt)[xt](e)!==u.FileType.file}}function or(e,s,a){babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].dispatch("files/update",{id:e,fields:{progress:s===100?99:s,status:a}})}function dr(e,s){babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].dispatch("messages/delete",{id:e});babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].dispatch("files/delete",{id:s})}function cr(e){const s=e.getId();const a=e.getBinary();const t=babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt](e);babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].dispatch("files/add",{id:s,chatId:e.getCustomData("chatId"),authorId:g.Core.getUserId(),name:a.name,type:babelHelpers.classPrivateFieldLooseBase(this,xt)[xt](a),extension:babelHelpers.classPrivateFieldLooseBase(this,_t)[_t](a),status:e.isFailed()?u.FileStatus.error:u.FileStatus.progress,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,Nt)[Nt]().name,...t})}function nr(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt](e);babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].dispatch("files/update",{id:e.getId(),fields:{...s}})}function br(e){babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].dispatch("files/update",{id:e.getId(),fields:{size:e.getSize()}})}function hr(e){if(e.getCustomData("sendAsFile")){return{}}const s={blob:e.getPreviewUrl(),width:e.getPreviewWidth(),height:e.getPreviewHeight()};const a={};if(s.blob){a.image={width:s.width,height:s.height};a.urlPreview=s.blob}if(e.getClientPreview()){a.urlShow=URL.createObjectURL(e.getBinary())}return a}function vr(e){return babelHelpers.classPrivateFieldLooseBase(this,kt)[kt](e).diskFolderId}function pr(e){let s=u.FileType.file;if(e.type.startsWith("image")){s=u.FileType.image}else if(e.type.startsWith("video")){s=u.FileType.video}return s}function gr(e){return e.name.split(".").splice(-1)[0]}function ur(e){return babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].getters["chats/get"](e)}function Pr(){const e=g.Core.getUserId();return babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].getters["users/get"](e)}function Fr(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,kt)[kt](e))==null?void 0:s.chatId}function Lr(e,s,a,t){if(!babelHelpers.classPrivateFieldLooseBase(this,It)[It][e]){babelHelpers.classPrivateFieldLooseBase(this,It)[It][e]={filesPreviewStatus:{},dialogId:a,text:"",autoUpload:t}}s.forEach((s=>{const a=s.getId();if(!babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].filesPreviewStatus){babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].filesPreviewStatus={}}babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].filesPreviewStatus[a]=false}))}function Hr(e,s){babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].filesPreviewStatus[s]=true}function fr(e,s){babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].text=s}function Br(e,s){babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].autoUpload=s}function mr(e){const s=[];const a=this.getFiles(e);const t=babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].text;const r=babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].dialogId;const i=t.length>0;if(a.length>1&&i){s.push({dialogId:r,text:t})}a.forEach((e=>{var l;if(e.getError()){return}const o=n.Utils.text.getUuidV4();e.setCustomData("messageId",o);if(a.length===1&&i){e.setCustomData("messageText",t)}s.push({fileId:e.getId(),tempMessageId:e.getCustomData("tempMessageId"),dialogId:r,text:(l=e.getCustomData("messageText"))!=null?l:""})}));return s}function yr(e){if(!babelHelpers.classPrivateFieldLooseBase(this,It)[It][e]||!babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].autoUpload||babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].wasSent){return false}const{filesPreviewStatus:s}=babelHelpers.classPrivateFieldLooseBase(this,It)[It][e];return Object.values(s).every((e=>e===true))}function Ir(e){if(!babelHelpers.classPrivateFieldLooseBase(this,zt)[zt](e)){return}babelHelpers.classPrivateFieldLooseBase(this,It)[It][e].wasSent=true;const s=babelHelpers.classPrivateFieldLooseBase(this,qt)[qt](e);s.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,yt)[yt].sendMessageWithFile(e)}));this.start(e)}function Mr(e,s){const a=n.Utils.text.getUuidV4();const t=e.id.slice(1);const r=`${a}|${t}`;return{tempMessageId:a,tempFileId:r,dialogId:s,file:e,chatId:babelHelpers.classPrivateFieldLooseBase(this,kt)[kt](s).chatId}}function Cr(e){if(e.getCode()==="MAX_FILE_SIZE_EXCEEDED"){BX.UI.Notification.Center.notify({content:`${e.getMessage()}<br>${e.getDescription()}`})}}function wr(e){babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt].dispatch("messages/update",{id:e,fields:{error:true}})}er.instance=null;class Sr{changeSetting(e,s){v.Logger.warn("SettingsService: changeSetting",e,s);g.Core.getStore().dispatch("application/settings/set",{[e]:s});return p.runAction(u.RestMethod.imV2SettingsGeneralUpdate,{data:{userId:g.Core.getUserId(),name:e,value:s}}).catch((e=>{console.error("SettingsService: changeSetting error",e)}))}}class Or{getDialogIdByUserCode(e){return g.Core.getRestClient().callMethod(u.RestMethod.linesDialogGet,{USER_CODE:e}).then((e=>{const{dialog_id:s}=e.data();return s})).catch((e=>{console.error("LinesService: error getting dialog id",e)}))}}var Ur=babelHelpers.classPrivateFieldLooseKey("onCreateError");class jr{constructor(){Object.defineProperty(this,Ur,{value:Rr})}async createChat(){const e=new ds;const s=await e.createChat({type:u.ChatType.copilot}).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Ur)[Ur](e)}));await e.loadChatWithMessages(s).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Ur)[Ur](e)}));return s}}function Rr(e){console.error("Copilot chat create error",e);throw new Error("Copilot chat create error")}e.RecentService=V;e.ChatService=ds;e.MessageService=ua;e.SendingService=xa;e.NotificationService=lt;e.DiskService=dt;e.UnreadRecentService=ct;e.UploadingService=er;e.SettingsService=Sr;e.LinesService=Or;e.CopilotService=jr})(this.BX.Messenger.v2.Provider.Service=this.BX.Messenger.v2.Provider.Service||{},BX.Messenger.v2.Provider.Service,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Vue3.Vuex,BX,BX,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Event,BX.UI.Uploader,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Const);
//# sourceMappingURL=registry.bundle.map.js