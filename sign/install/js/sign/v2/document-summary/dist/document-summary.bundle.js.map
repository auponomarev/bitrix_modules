{"version":3,"file":"document-summary.bundle.js","sources":["../src/index.js"],"sourcesContent":["import { Dom, Loc, Reflection, Tag, Text, Type } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { MenuManager } from 'main.popup';\nimport { Api } from 'sign.v2.api';\nimport { Button } from 'ui.buttons';\nimport { LangSelector } from 'sign.v2.lang-selector';\nimport './style.css';\n\nimport type { DocumentSummaryConfig } from './types/config';\n\nconst buttonClassList = [\n\t'ui-btn',\n\t'ui-btn-sm',\n\t'ui-btn-light-border',\n\t'ui-btn-round',\n];\nconst menuPrefix = 'sign-member-communication';\n\nexport class DocumentSummary extends EventEmitter\n{\n\t#editDocumentBtn: HTMLElement;\n\t#api: Api;\n\t#blocks: HTMLElement;\n\t#filledBlocks: HTMLElement;\n\t#menus: Array<Menu>;\n\t#summaryContainer: HTMLElement;\n\tdocumentData;\n\tentityData;\n\tcommunications;\n\t#langContainer: HTMLElement;\n\t#config: DocumentSummaryConfig;\n\t#langSelector: LangSelector;\n\n\tconstructor(config: DocumentSummaryConfig)\n\t{\n\t\tsuper();\n\t\tthis.#config = config;\n\t\tthis.setEventNamespace('BX.Sign.V2.DocumentSummary');\n\t\tthis.#editDocumentBtn = Tag.render`\n\t\t\t<span\n\t\t\t\tclass=\"${buttonClassList.join(' ')}\"\n\t\t\t\tonclick=\"${() => this.emit('showEditor')}\"\n\t\t\t>\n\t\t\t\t${Loc.getMessage('SIGN_DOCUMENT_INFO_EDIT')}\n\t\t\t</span>\n\t\t`;\n\t\tthis.#api = new Api();\n\t\tthis.#blocks = Tag.render`\n\t\t\t<p class=\"sign-document-info__details_structure\"></p>\n\t\t`;\n\t\tthis.#filledBlocks = Tag.render`\n\t\t\t<p class=\"sign-document-info__details_structure\"></p>\n\t\t`;\n\t\tthis.#langSelector = new LangSelector(\n\t\t\tthis.#config.region,\n\t\t\tthis.#config.languages\n\t\t);\n\t\tthis.#langContainer = Tag.render`\n\t\t\t<div class=\"sign-blank-selector__lang-container\">\n\t\t\t\t${this.#langSelector.getLayout()}\n\t\t\t\t<span data-hint=\"${Loc.getMessage('SIGN_DOCUMENT_LANGUAGE_BUTTON_INFO')}\"></span>\n\t\t\t</div>\n\t\t`;\n\t\tBX.UI.Hint.init(this.#langContainer);\n\t\tthis.#menus = [];\n\t\tthis.documentData = {};\n\t\tthis.entityData = {};\n\t\tthis.communications = {};\n\t}\n\n\tgetLayout(): HTMLElement\n\t{\n\t\tthis.#langSelector.setDocumentUid(this.documentData.uid);\n\n\t\tthis.#summaryContainer = Tag.render`\n\t\t\t<div class=\"sign-document-info\">\n\t\t\t\t<div class=\"sign-document-indo__summary-title-wrapper\">\n\t\t\t\t\t<p class=\"sign-document-info__title\">\n\t\t\t\t\t\t${Loc.getMessage('SIGN_DOCUMENT_INFO_SEND')}\n\t\t\t\t\t</p>\n\t\t\t\t\t${this.#langContainer}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"sign-document-info__summary\">\n\t\t\t\t\t${this.#createDocumentDetails()}\n\t\t\t\t\t${this.#editDocumentBtn}\n\t\t\t\t</div>\n\t\t\t\t${this.#createParties()}\n\t\t\t</div>\n\t\t`;\n\n\t\treturn this.#summaryContainer;\n\t}\n\n\t#createDocumentDetails(): HTMLElement\n\t{\n\t\tthis.renderDocumentDetails();\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"sign-document-info__details\">\n\t\t\t\t<div class=\"sign-document-info__details_title\">\n\t\t\t\t\t<span>${Text.encode(this.documentData.title ?? '')}</span>\n\t\t\t\t\t<span\n\t\t\t\t\t\tclass=\"sign-document-info__details_edit-title-btn\"\n\t\t\t\t\t\tonclick=\"${({ target: button }) => {\n\t\t\t\t\t\t\tthis.#toggleTitleEditor(button, true);\n\t\t\t\t\t\t}}\"\n\t\t\t\t\t>\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t${this.#blocks}\n\t\t\t\t${this.#filledBlocks}\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t#createTitleEditor(): HTMLElement\n\t{\n\t\tconst okButtonClassName = [\n\t\t\t...buttonClassList.slice(0, 2),\n\t\t\t'ui-btn-primary',\n\t\t\t'sign-document-info__title-editor_ok-btn',\n\t\t].join(' ');\n\t\tconst discardButtonClassName = [\n\t\t\t...buttonClassList.slice(0, 3),\n\t\t\t'sign-document-info__title-editor_discard-btn',\n\t\t].join(' ');\n\t\tconst input = Tag.render`<input type=\"text\" class=\"ui-ctl-element\" />`;\n\t\tinput.value = this.documentData.title ?? '';\n\t\tthis.#focusInput(input);\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"sign-document-info__title-editor\">\n\t\t\t\t<div class=\"sign-document-info__title-editor_controls\">\n\t\t\t\t\t<span class=\"ui-ctl ui-ctl-textbox ui-ctl-w100\">\n\t\t\t\t\t\t${input}\n\t\t\t\t\t</span>\n\t\t\t\t\t<span\n\t\t\t\t\t\tclass=\"${okButtonClassName}\"\n\t\t\t\t\t\tonclick=\"${async ({ target }) => {\n\t\t\t\t\t\t\tDom.addClass(target, 'ui-btn-wait');\n\t\t\t\t\t\t\tawait this.#modifyDocumentTitle(input.value);\n\t\t\t\t\t\t\tDom.removeClass(target, 'ui-btn-wait');\n\t\t\t\t\t\t\tthis.#toggleTitleEditor(target, false);\n\t\t\t\t\t\t}}\"\n\t\t\t\t\t>\n\t\t\t\t\t</span>\n\t\t\t\t\t<span\n\t\t\t\t\t\tclass=\"${discardButtonClassName}\"\n\t\t\t\t\t\tonclick=\"${({ target }) => {\n\t\t\t\t\t\t\tthis.#toggleTitleEditor(target, false);\n\t\t\t\t\t\t}}\"\n\t\t\t\t\t>\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<p class=\"sign-document-info__title-editor_help\">\n\t\t\t\t\t${Loc.getMessage('SIGN_DOCUMENT_INFO_TITLE_EDITOR_HELP')}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t#toggleTitleEditor(button: HTMLElement, shouldShow: boolean)\n\t{\n\t\tconst summaryNode = button.closest('.sign-document-info__summary');\n\t\tif (shouldShow)\n\t\t{\n\t\t\tDom.clean(summaryNode);\n\t\t\tDom.append(this.#createTitleEditor(), summaryNode);\n\n\t\t\treturn;\n\t\t}\n\n\t\tDom.replace(summaryNode.firstElementChild, this.#createDocumentDetails());\n\t\tDom.append(this.#editDocumentBtn, summaryNode);\n\t}\n\n\t#focusInput(input: HTMLElement)\n\t{\n\t\tconst observer = new MutationObserver(() => {\n\t\t\tif (input.isConnected)\n\t\t\t{\n\t\t\t\tinput.focus();\n\t\t\t\tobserver.disconnect();\n\t\t\t}\n\t\t});\n\t\tobserver.observe(document.body, { childList: true, subtree: true });\n\t}\n\n\tasync #modifyDocumentTitle(newValue: string)\n\t{\n\t\tconst { title = '', uid = '' } = this.documentData;\n\t\tif (title === newValue)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tawait this.#api.modifyTitle(uid, newValue);\n\t\t\tthis.documentData = {\n\t\t\t\t...this.documentData,\n\t\t\t\ttitle: newValue,\n\t\t\t};\n\t\t\tthis.emit('changeTitle', { newValue });\n\t\t}\n\t\tcatch (ex)\n\t\t{\n\t\t\tconsole.error(ex);\n\t\t}\n\t}\n\n\t#attachMenu(idMeans: HTMLElement, entityData): Menu\n\t{\n\t\tlet menuItems = [];\n\t\tconst menuId = `${menuPrefix}-${entityData.entityTypeId}-${entityData.id}`;\n\t\tif (this.#menus[menuId])\n\t\t{\n\t\t\tlet items = this.#menus[menuId].getMenuItems();\n\t\t\tconst swap = (array, from, to) => {\n\t\t\t\tconst tmp = array[to];\n\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\tarray[to] = array[from];\n\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\tarray[from] = tmp;\n\t\t\t};\n\n\t\t\twhile (items.length > 1)\n\t\t\t{\n\t\t\t\tif (items[0].id === 'show-member')\n\t\t\t\t{\n\t\t\t\t\tswap(items, 0, 1);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tthis.#menus[menuId].removeMenuItem(items[0].id);\n\t\t\t\titems = this.#menus[menuId].getMenuItems();\n\t\t\t}\n\t\t}\n\n\t\tthis.#api.loadCommunications(entityData.uid).then(async (multiFields) => {\n\t\t\tlet selectedCommunication = {};\n\t\t\tconst restrictions = await this.#api.loadRestrictions();\n\t\t\tconst mapper = (communication) => {\n\t\t\t\tlet text = communication.VALUE;\n\t\t\t\tif (communication?.TYPE === 'PHONE' && BX.PhoneNumberParser)\n\t\t\t\t{\n\t\t\t\t\tBX.PhoneNumberParser.getInstance().parse(communication.VALUE).then((parsedNumber) => {\n\t\t\t\t\t\ttext = parsedNumber.format(BX.PhoneNumber.Format.INTERNATIONAL);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif ((communication?.TYPE === 'PHONE' && restrictions.smsAllowed)\n\t\t\t\t\t|| (communication?.TYPE === 'EMAIL' && Object.keys(selectedCommunication).length === 0))\n\t\t\t\t{\n\t\t\t\t\tselectedCommunication = communication;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\ttext,\n\t\t\t\t\tonclick: ({ target }) => {\n\t\t\t\t\t\tthis.#updateCommunications(entityData, communication);\n\t\t\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\t\t\tidMeans.firstElementChild.textContent = text;\n\t\t\t\t\t\tthis.#menus[menuId].close();\n\t\t\t\t\t\tthis.#updatePhoneAttr(idMeans, communication?.TYPE === 'PHONE' ? communication.VALUE : null);\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t};\n\n\t\t\tmenuItems = [\n\t\t\t\t// eslint-disable-next-line no-unsafe-optional-chaining\n\t\t\t\t...(multiFields?.EMAIL ? multiFields?.EMAIL.map((element) => mapper(element)) : []),\n\t\t\t\t// eslint-disable-next-line no-unsafe-optional-chaining\n\t\t\t\t...(multiFields?.PHONE ? await Promise.all(multiFields?.PHONE.map(async (element) => {\n\t\t\t\t\tconst item = mapper(element);\n\t\t\t\t\titem.text = await this.#formatPhoneNumberForUi(item.text);\n\t\t\t\t\treturn item;\n\t\t\t\t})) : []),\n\t\t\t];\n\n\t\t\tmenuItems.map((item) => this.#menus[menuId].addMenuItem(item, null));\n\t\t\tthis.#updateCommunications(entityData, selectedCommunication);\n\n\t\t\tidMeans.firstElementChild.textContent = selectedCommunication?.TYPE === 'PHONE'\n\t\t\t\t? await this.#formatPhoneNumberForUi(selectedCommunication?.VALUE)\n\t\t\t\t: selectedCommunication?.VALUE\n\t\t\t;\n\n\t\t\tthis.#updatePhoneAttr(idMeans, selectedCommunication?.TYPE === 'PHONE'\n\t\t\t\t? await this.#getNormalizedPhoneNumber(selectedCommunication?.VALUE)\n\t\t\t\t: null\n\t\t\t);\n\t\t}).catch(() => {});\n\n\t\tmenuItems.push({\n\t\t\tid: 'show-member',\n\t\t\ttext: Loc.getMessage('SIGN_DOCUMENT_INFO_OPEN_VIEW'),\n\t\t\tonclick: () => {\n\t\t\t\tthis.#showMemberInfo(idMeans, entityData);\n\t\t\t\tthis.#menus[menuId].close();\n\t\t\t},\n\t\t});\n\n\t\tif (!this.#menus[menuId])\n\t\t{\n\t\t\tthis.#menus[menuId] = MenuManager.create({\n\t\t\t\tid: menuId,\n\t\t\t\titems: menuItems,\n\t\t\t});\n\t\t\tconst popup = this.#menus[menuId].getPopupWindow();\n\t\t\tpopup.setBindElement(idMeans);\n\t\t}\n\n\t\t// eslint-disable-next-line no-param-reassign\n\t\tidMeans.firstElementChild.textContent = menuItems[0].text;\n\n\t\treturn this.#menus[menuId];\n\t}\n\n\tasync #formatPhoneNumberForUi(phone: string): Promise<string>\n\t{\n\t\tlet phoneFormatted = phone;\n\t\tif (BX.PhoneNumberParser)\n\t\t{\n\t\t\tphoneFormatted = await BX.PhoneNumberParser.getInstance().parse(phone).then((parsedNumber) => {\n\t\t\t\treturn parsedNumber.format(BX.PhoneNumber.Format.INTERNATIONAL);\n\t\t\t});\n\t\t}\n\n\t\treturn phoneFormatted;\n\t}\n\n\tasync #getNormalizedPhoneNumber(phone: string): Promise<string>\n\t{\n\t\tif (BX.PhoneNumberParser)\n\t\t{\n\t\t\tconst parsedNumber = await BX.PhoneNumberParser.getInstance().parse(phone);\n\n\t\t\treturn parsedNumber.isValid()\n\t\t\t\t? parsedNumber.format(BX.PhoneNumber.Format.E164)\n\t\t\t\t: parsedNumber.rawNumber\n\t\t\t;\n\t\t}\n\n\t\treturn phone;\n\t}\n\n\thighlightCommunicationWithError(phoneNumber: string): void\n\t{\n\t\tconst aIdMeans = this.#summaryContainer.querySelectorAll(\n\t\t\t`.sign-document-info__party_id-means[data-phone-normalized=\"${phoneNumber}\"]`,\n\t\t);\n\t\taIdMeans.forEach((elem) => {\n\t\t\tconst wrapper = elem.closest('.sign-document-info__party');\n\t\t\tDom.addClass(wrapper, '--validation-error');\n\t\t});\n\t}\n\n\t#updatePhoneAttr(elem: Element, phone: string = null): void\n\t{\n\t\tif (Type.isStringFilled(phone))\n\t\t{\n\t\t\tDom.attr(elem, 'data-phone-normalized', phone);\n\t\t}\n\t\telse\n\t\t{\n\t\t\telem.removeAttribute('data-phone-normalized');\n\t\t}\n\t}\n\n\tresetCommunicationErrors(): void\n\t{\n\t\tconst elems = this.#summaryContainer.querySelectorAll('.sign-document-info__party');\n\t\telems.forEach((elem) => {\n\t\t\tDom.removeClass(elem, '--validation-error');\n\t\t});\n\t}\n\n\t#showMemberInfo(idMeans: HTMLElement, entityData: Object)\n\t{\n\t\tconst { Instance: slider } = Reflection.getClass('BX.SidePanel');\n\t\tslider.open(entityData.url, {\n\t\t\tcacheable: false,\n\t\t\tallowChangeHistory: false,\n\t\t\tevents: {\n\t\t\t\tonClose: () => {\n\t\t\t\t\tthis.#attachMenu(idMeans, entityData);\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\t#createParties(): Array<HTMLElement>\n\t{\n\t\tconst parties = [\n\t\t\t{\n\t\t\t\tpartyTitle: Loc.getMessage('SIGN_DOCUMENT_INFO_FIRST_PARTY'),\n\t\t\t\tentityData: this.entityData.company,\n\t\t\t},\n\t\t\t{\n\t\t\t\tpartyTitle: Loc.getMessage('SIGN_DOCUMENT_INFO_PARTNER'),\n\t\t\t\tentityData: this.entityData.contact,\n\t\t\t},\n\t\t];\n\t\tObject.keys(MenuManager.Data).forEach((menuId) => {\n\t\t\tif (menuId.includes(menuPrefix))\n\t\t\t{\n\t\t\t\tMenuManager.destroy(menuId);\n\t\t\t}\n\t\t});\n\n\t\tthis.#menus = [];\n\n\t\treturn parties.map((party) => {\n\t\t\tconst { partyTitle, entityData } = party;\n\t\t\tconst { title } = entityData;\n\t\t\tconst idMeans = Tag.render`\n\t\t\t\t<span\n\t\t\t\t\tclass=\"sign-document-info__party_id-means\"\n\t\t\t\t\tonclick=\"${() => menu.show()}\"\n\t\t\t\t>\n\t\t\t\t\t<span></span>\n\t\t\t\t</span>\n\t\t\t`;\n\t\t\tconst menu = this.#attachMenu(idMeans, entityData);\n\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"sign-document-info__party\">\n\t\t\t\t\t<div class=\"sign-document-info__party_summary\">\n\t\t\t\t\t\t<p class=\"sign-document-info__party_title\">${partyTitle}</p>\n\t\t\t\t\t\t<span class=\"sign-document-info__party_member-name\">\n\t\t\t\t\t\t\t${Text.encode(title)}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class=\"sign-document-info__party_status\">\n\t\t\t\t\t\t\t${Loc.getMessage('SIGN_DOCUMENT_INFO_NOT_SIGNED')}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"sign-document-info__party_id\">\n\t\t\t\t\t\t<p class=\"sign-document-info__party_title\">\n\t\t\t\t\t\t\t${Loc.getMessage('SIGN_DOCUMENT_INFO_ID')}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t${idMeans}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#updateCommunications(entityData, communication)\n\t{\n\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-typeof\n\t\tif (typeof communication === 'undefined')\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst { TYPE: type, VALUE: value } = communication;\n\t\tthis.communications = {\n\t\t\t...this.communications,\n\t\t\t[entityData.type]: { type, value },\n\t\t};\n\n\t\tthis.resetCommunicationErrors();\n\t}\n\n\trenderDocumentDetails()\n\t{\n\t\tconst blocks = this.documentData.blocks ?? [];\n\t\tconst addedBlocks = blocks.filter((block): boolean => block.party === 1).length;\n\t\tconst addedFilledBlocks = blocks.filter((block): boolean => block.party >= 2).length;\n\t\tconst addedBlocksTitle = Loc.getMessage('SIGN_DOCUMENT_INFO_ADDED_BLOCKS', {\n\t\t\t'#CNT#': addedBlocks,\n\t\t});\n\t\tconst filledBlocksTitle = Loc.getMessage('SIGN_DOCUMENT_INFO_ADDED_FILLED_FIELDS', {\n\t\t\t'#CNT#': addedFilledBlocks,\n\t\t});\n\t\tthis.#blocks.textContent = addedBlocksTitle;\n\t\tthis.#filledBlocks.textContent = filledBlocksTitle;\n\t}\n}\n"],"names":["buttonClassList","menuPrefix","DocumentSummary","EventEmitter","constructor","config","setEventNamespace","Tag","render","join","emit","Loc","getMessage","Api","LangSelector","region","languages","getLayout","BX","UI","Hint","init","documentData","entityData","communications","setDocumentUid","uid","highlightCommunicationWithError","phoneNumber","aIdMeans","querySelectorAll","forEach","elem","wrapper","closest","Dom","addClass","resetCommunicationErrors","elems","removeClass","renderDocumentDetails","blocks","addedBlocks","filter","block","party","length","addedFilledBlocks","addedBlocksTitle","filledBlocksTitle","textContent","Text","encode","title","target","button","okButtonClassName","slice","discardButtonClassName","input","value","shouldShow","summaryNode","clean","append","replace","firstElementChild","observer","MutationObserver","isConnected","focus","disconnect","observe","document","body","childList","subtree","newValue","modifyTitle","ex","console","error","idMeans","menuItems","menuId","entityTypeId","id","items","getMenuItems","swap","array","from","to","tmp","removeMenuItem","loadCommunications","then","multiFields","selectedCommunication","restrictions","loadRestrictions","mapper","communication","text","VALUE","TYPE","PhoneNumberParser","getInstance","parse","parsedNumber","format","PhoneNumber","Format","INTERNATIONAL","smsAllowed","Object","keys","onclick","close","EMAIL","map","element","PHONE","Promise","all","item","addMenuItem","catch","push","MenuManager","create","popup","getPopupWindow","setBindElement","phone","phoneFormatted","isValid","E164","rawNumber","Type","isStringFilled","attr","removeAttribute","Instance","slider","Reflection","getClass","open","url","cacheable","allowChangeHistory","events","onClose","parties","partyTitle","company","contact","Data","includes","destroy","menu","show","type"],"mappings":"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"}